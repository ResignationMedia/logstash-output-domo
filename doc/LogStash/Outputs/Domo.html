<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: LogStash::Outputs::Domo
  
    &mdash; logstash-output-domo
  
</title>

  <link rel="stylesheet" href="../../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "LogStash::Outputs::Domo";
  relpath = '../../';
</script>


  <script type="text/javascript" charset="utf-8" src="../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../../_index.html">Index (D)</a> &raquo;
    <span class='title'>LogStash</span> &raquo; <span class='title'>Outputs</span>
     &raquo; 
    <span class="title">Domo</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: LogStash::Outputs::Domo
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName">Base</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Base</li>
          
            <li class="next">LogStash::Outputs::Domo</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/logstash/outputs/domo.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Write events to a DOMO Streams Dataset.</p>

<p>Requires DOMO OAuth credentials. <a
href="https://developer.domo.com/docs/authentication/overview-4">developer.domo.com/docs/authentication/overview-4</a></p>

<p>Additionally, the DOMO Streams API requires that the Dataset and Stream be
made via the API. Streams cannot be added to existing Datasets. <a
href="https://developer.domo.com/docs/stream/overview">developer.domo.com/docs/stream/overview</a></p>


  </div>
</div>
<div class="tags">
  

</div><h2>Defined Under Namespace</h2>
<p class="children">
  
    
  
    
      <strong class="classes">Classes:</strong> <span class='object_link'><a href="Domo/ColumnTypeError.html" title="LogStash::Outputs::Domo::ColumnTypeError (class)">ColumnTypeError</a></span>
    
  
</p>




  <h2>Instance Attribute Summary <small><a href="#" class="summary_toggle">collapse</a></small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#commit_lock_key-instance_method" title="#commit_lock_key (instance method)">#<strong>commit_lock_key</strong>  &#x21d2; String </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The name of the redis key for locking the current commit.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#dataset_columns-instance_method" title="#dataset_columns (instance method)">#<strong>dataset_columns</strong>  &#x21d2; Array&lt;String&gt; </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The Domo Dataset&#39;s columns.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#lock_key-instance_method" title="#lock_key (instance method)">#<strong>lock_key</strong>  &#x21d2; String </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The name of the redis key for the distributed lock.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#part_num_key-instance_method" title="#part_num_key (instance method)">#<strong>part_num_key</strong>  &#x21d2; String </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The redis key for getting / incrementing the part number.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#pending_lock_key-instance_method" title="#pending_lock_key (instance method)">#<strong>pending_lock_key</strong>  &#x21d2; String </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The name of the redis key for locking the pending queue.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#pipeline_id-instance_method" title="#pipeline_id (instance method)">#<strong>pipeline_id</strong>  &#x21d2; String </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The Logstash Pipeline ID.</p>
</div></span>
  
</li>

    
  </ul>




  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#close-instance_method" title="#close (instance method)">#<strong>close</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#commit_ready%3F-instance_method" title="#commit_ready? (instance method)">#<strong>commit_ready?</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Let&#39;s the caller know if it&#39;s ok to fire a commit.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#commit_stream-instance_method" title="#commit_stream (instance method)">#<strong>commit_stream</strong>(shutdown = false)  &#x21d2; Symbol </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Commit the active Stream Execution, and (re)set all the appropriate
attributes on the queue.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#dlq_enabled%3F-instance_method" title="#dlq_enabled? (instance method)">#<strong>dlq_enabled?</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Checks if the Dead Letter Queue is enabled.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#encode_event_data-instance_method" title="#encode_event_data (instance method)">#<strong>encode_event_data</strong>(event)  &#x21d2; String </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>CSV encode event data to pass to DOMO.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_queue-instance_method" title="#get_queue (instance method)">#<strong>get_queue</strong>  &#x21d2; Domo::Queue::Redis::JobQueue </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Get the active queue.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#lock_hosts-instance_method" title="#lock_hosts (instance method)">#<strong>lock_hosts</strong>(lock_hosts, lock_ports, lock_passwords)  &#x21d2; Array&lt;Redis&gt; </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Builds an array of Redis clients out of the plugin&#39;s configuration
parameters for distributed locking.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#lock_hosts_tls_opts-instance_method" title="#lock_hosts_tls_opts (instance method)">#<strong>lock_hosts_tls_opts</strong>(lock_hosts)  &#x21d2; Array&lt;Redis&gt; </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Loop through lock_hosts from the configuration and add TLS options if
they&#39;re using rediss.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#merge_pending_jobs!-instance_method" title="#merge_pending_jobs! (instance method)">#<strong>merge_pending_jobs!</strong>(data, shutdown = false)  &#x21d2; Array<sup>?</sup> </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Merge the data in all of our pending jobs If we&#39;re shutting down or the
size of the merged data exceeds upload_min_batch_size, then the data will
be returned.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#multi_receive-instance_method" title="#multi_receive (instance method)">#<strong>multi_receive</strong>(events)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#openssl_opt_from_string-instance_method" title="#openssl_opt_from_string (instance method)">#<strong>openssl_opt_from_string</strong>(val)  &#x21d2; Integer, String </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Figure out which OpenSSL::SSL::VERIFY constant matches with a string on the
config.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#recursive_symbolize-instance_method" title="#recursive_symbolize (instance method)">#<strong>recursive_symbolize</strong>(obj)  &#x21d2; Hash </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Symbol all keys in a hash, as well as keys from embedded hashes.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#redlock_retry_count-instance_method" title="#redlock_retry_count (instance method)">#<strong>redlock_retry_count</strong>(retry_delay = 200, minimum_retry_count = 3)  &#x21d2; Integer </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Calculates an acceptable retry count for trying to acquiring a distributed
lock.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#register-instance_method" title="#register (instance method)">#<strong>register</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#ruby_domo_type_match%3F-instance_method" title="#ruby_domo_type_match? (instance method)">#<strong>ruby_domo_type_match?</strong>(val, domo_column_type)  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Takes a given value and returns a boolean indicating if its type matches
the corresponding Domo column.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#send_to_domo-instance_method" title="#send_to_domo (instance method)">#<strong>send_to_domo</strong>(force_pending = false, force_run = false)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Send Event data using the DOMO Streams API.</p>
</div></span>
  
</li>

      
        <li class="private ">
  <span class="summary_signature">
    
      <a href="#symbolize_redis_client_args-instance_method" title="#symbolize_redis_client_args (instance method)">#<strong>symbolize_redis_client_args</strong>(redis_client_args)  &#x21d2; Hash </a>
    

    
  </span>
  
  
  
  <span class="note title private">private</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Convert all keys in the redis_client hash to symbols because Logstash makes
them keys, but redis-rb wants symbols.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#try_commit-instance_method" title="#try_commit (instance method)">#<strong>try_commit</strong>(shutdown = false)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  


  
  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id=""></span>
      <div class="method_details first">
  <h3 class="signature first" id="commit_lock_key-instance_method">
  
    #<strong>commit_lock_key</strong>  &#x21d2; <tt>String</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>The name of the redis key for locking the current commit.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


205
206
207</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/logstash/outputs/domo.rb', line 205</span>

<span class='kw'>def</span> <span class='id identifier rubyid_commit_lock_key'>commit_lock_key</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>logstash-output-domo:</span><span class='embexpr_beg'>#{</span><span class='ivar'>@dataset_id</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='ivar'>@stream_id</span><span class='embexpr_end'>}</span><span class='tstring_content'>_commit_lock</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="dataset_columns=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="dataset_columns-instance_method">
  
    #<strong>dataset_columns</strong>  &#x21d2; <tt>Array&lt;String&gt;</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns The Domo Dataset&#39;s columns.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array&lt;String&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The Domo Dataset&#39;s columns.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


175
176
177</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/logstash/outputs/domo.rb', line 175</span>

<span class='kw'>def</span> <span class='id identifier rubyid_dataset_columns'>dataset_columns</span>
  <span class='ivar'>@dataset_columns</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="lock_key-instance_method">
  
    #<strong>lock_key</strong>  &#x21d2; <tt>String</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>The name of the redis key for the distributed lock.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


191
192
193</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/logstash/outputs/domo.rb', line 191</span>

<span class='kw'>def</span> <span class='id identifier rubyid_lock_key'>lock_key</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>logstash-output-domo:</span><span class='embexpr_beg'>#{</span><span class='ivar'>@dataset_id</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='ivar'>@stream_id</span><span class='embexpr_end'>}</span><span class='tstring_content'>_lock</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="part_num_key-instance_method">
  
    #<strong>part_num_key</strong>  &#x21d2; <tt>String</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>The redis key for getting / incrementing the part number.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


212
213
214
215
216
217</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/logstash/outputs/domo.rb', line 212</span>

<span class='kw'>def</span> <span class='id identifier rubyid_part_num_key'>part_num_key</span>
  <span class='kw'>return</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_part_num_key'>part_num_key</span> <span class='kw'>if</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'><span class='object_link'><a href="" title="LogStash::Outputs::Domo (class)">Domo</a></span></span><span class='op'>::</span><span class='const'>Queue</span><span class='op'>::</span><span class='const'>RedisQueue</span>

  <span class='id identifier rubyid_part_num_key'>part_num_key</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='const'><span class='object_link'><a href="" title="LogStash::Outputs::Domo (class)">Domo</a></span></span><span class='op'>::</span><span class='const'>Queue</span><span class='op'>::</span><span class='const'>RedisQueue</span><span class='op'>::</span><span class='const'>KEY_PREFIX_FORMAT</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='lbrace'>{</span><span class='symbol'>:dataset_id</span> <span class='op'>=&gt;</span> <span class='ivar'>@dataset_id</span><span class='comma'>,</span> <span class='symbol'>:stream_id</span> <span class='op'>=&gt;</span> <span class='ivar'>@stream_id</span><span class='rbrace'>}</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_part_num_key'>part_num_key</span><span class='embexpr_end'>}</span><span class='embexpr_beg'>#{</span><span class='const'><span class='object_link'><a href="" title="LogStash::Outputs::Domo (class)">Domo</a></span></span><span class='op'>::</span><span class='const'>Queue</span><span class='op'>::</span><span class='const'>RedisQueue</span><span class='op'>::</span><span class='const'>KEY_SUFFIXES</span><span class='lbracket'>[</span><span class='symbol'>:PART_NUM</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="pending_lock_key-instance_method">
  
    #<strong>pending_lock_key</strong>  &#x21d2; <tt>String</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>The name of the redis key for locking the pending queue.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


198
199
200</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/logstash/outputs/domo.rb', line 198</span>

<span class='kw'>def</span> <span class='id identifier rubyid_pending_lock_key'>pending_lock_key</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>logstash-output-domo:</span><span class='embexpr_beg'>#{</span><span class='ivar'>@dataset_id</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='ivar'>@stream_id</span><span class='embexpr_end'>}</span><span class='tstring_content'>_pending_lock</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="pipeline_id-instance_method">
  
    #<strong>pipeline_id</strong>  &#x21d2; <tt>String</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>The Logstash Pipeline ID.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


180
181
182
183
184
185
186</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/logstash/outputs/domo.rb', line 180</span>

<span class='kw'>def</span> <span class='id identifier rubyid_pipeline_id'>pipeline_id</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:execution_context</span><span class='rparen'>)</span> <span class='kw'>and</span> <span class='id identifier rubyid_execution_context'>execution_context</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:pipeline</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_execution_context'>execution_context</span><span class='period'>.</span><span class='id identifier rubyid_pipeline'>pipeline</span><span class='period'>.</span><span class='id identifier rubyid_pipeline_id'>pipeline_id</span>
  <span class='kw'>else</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>main</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="close-instance_method">
  
    #<strong>close</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


913
914
915
916
917
918
919
920
921
922
923
924
925
926
927
928
929
930
931</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/logstash/outputs/domo.rb', line 913</span>

<span class='kw'>def</span> <span class='id identifier rubyid_close'>close</span>
  <span class='ivar'>@queue</span> <span class='op'>=</span> <span class='id identifier rubyid_get_queue'>get_queue</span>
  <span class='id identifier rubyid_send_to_domo'>send_to_domo</span> <span class='kw'>until</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_processed?'>processed?</span>
  <span class='id identifier rubyid_try_commit'>try_commit</span><span class='lparen'>(</span><span class='kw'>true</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_commit_ready?'>commit_ready?</span>
  <span class='comment'># Commit if we&#39;re ready
</span>  <span class='comment'># if commit_ready? and (@queue.commit_unscheduled? or @queue.commit_stalled?(@commit_delay))
</span>  <span class='comment'>#   if @commit_task.nil? or @commit_task.complete?
</span>  <span class='comment'>#     commit_status = commit_stream(true)
</span>  <span class='comment'>#     return
</span>  <span class='comment'>#   end
</span>  <span class='comment'>#   unless @commit_task&amp;.processing?
</span>  <span class='comment'>#     @commit_task.cancel
</span>  <span class='comment'>#     commit_status = commit_stream(true)
</span>  <span class='comment'>#     return
</span>  <span class='comment'>#   end
</span>  <span class='comment'>#   sleep(0.1) while @commit_task&amp;.processing?
</span>  <span class='comment'>#   commit_status = @commit_task&amp;.value
</span>  <span class='comment'># end
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="commit_ready?-instance_method">
  
    #<strong>commit_ready?</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Let&#39;s the caller know if it&#39;s ok to fire a commit</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


987
988
989
990
991
992
993
994
995
996</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/logstash/outputs/domo.rb', line 987</span>

<span class='kw'>def</span> <span class='id identifier rubyid_commit_ready?'>commit_ready?</span>
  <span class='id identifier rubyid_queue'>queue</span> <span class='op'>=</span> <span class='id identifier rubyid_get_queue'>get_queue</span>
  <span class='kw'>return</span> <span class='kw'>false</span> <span class='kw'>unless</span> <span class='id identifier rubyid_queue'>queue</span><span class='op'>&amp;.</span><span class='id identifier rubyid_execution_id'>execution_id</span> <span class='kw'>and</span> <span class='id identifier rubyid_queue'>queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_rows'>commit_rows</span> <span class='op'>&gt;</span> <span class='int'>0</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_queue'>queue</span><span class='period'>.</span><span class='id identifier rubyid_processed?'>processed?</span> <span class='kw'>and</span> <span class='id identifier rubyid_queue'>queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_status'>commit_status</span> <span class='op'>!=</span> <span class='symbol'>:running</span>
    <span class='kw'>return</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='ivar'>@commit_delay</span> <span class='op'>&lt;=</span> <span class='int'>0</span> <span class='kw'>or</span> <span class='id identifier rubyid_queue'>queue</span><span class='period'>.</span><span class='id identifier rubyid_last_commit'>last_commit</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='kw'>return</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_queue'>queue</span><span class='period'>.</span><span class='id identifier rubyid_next_commit'>next_commit</span><span class='lparen'>(</span><span class='ivar'>@commit_delay</span><span class='rparen'>)</span> <span class='op'>&lt;=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_utc'>utc</span>
  <span class='kw'>end</span>
  <span class='kw'>false</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="commit_stream-instance_method">
  
    #<strong>commit_stream</strong>(shutdown = false)  &#x21d2; <tt>Symbol</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Commit the active Stream Execution, and (re)set all the appropriate
attributes on the queue.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>shutdown</span>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>false</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Indicates that Logstash is shutting down which will force processing all
jobs and commit</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Symbol</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The status of the commit operation.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


736
737
738
739
740
741
742
743
744
745
746
747
748
749
750
751
752
753
754
755
756
757
758
759
760
761
762
763
764
765
766
767
768
769
770
771
772
773
774
775
776
777
778
779
780
781
782
783
784
785
786
787
788
789
790
791
792
793
794
795
796
797
798
799
800
801
802
803
804
805
806
807
808
809
810
811
812
813
814
815
816
817
818
819
820
821
822
823
824
825
826
827
828
829
830
831
832
833
834
835
836
837
838
839
840
841
842
843
844
845
846
847
848
849
850
851
852
853
854
855
856
857
858
859
860
861
862
863
864
865
866
867
868
869
870
871
872
873
874
875
876
877
878
879
880
881
882
883
884
885
886
887
888
889
890
891
892
893
894
895
896
897
898
899
900
901
902
903
904
905
906
907
908
909
910</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/logstash/outputs/domo.rb', line 736</span>

<span class='kw'>def</span> <span class='id identifier rubyid_commit_stream'>commit_stream</span><span class='lparen'>(</span><span class='id identifier rubyid_shutdown'>shutdown</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
  <span class='ivar'>@queue</span> <span class='op'>=</span> <span class='id identifier rubyid_get_queue'>get_queue</span>
  <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span> <span class='comment'># Notify other workers that the commit queue is open for business again
</span>  <span class='comment'># No point in continuing if we&#39;re not ready
</span>  <span class='kw'>return</span> <span class='symbol'>:wait</span> <span class='kw'>unless</span> <span class='id identifier rubyid_commit_ready?'>commit_ready?</span> <span class='kw'>or</span> <span class='id identifier rubyid_shutdown'>shutdown</span>
  <span class='comment'># Convert commit_delay to ms
</span>  <span class='id identifier rubyid_lock_ttl'>lock_ttl</span> <span class='op'>=</span> <span class='ivar'>@commit_delay</span> <span class='op'>*</span> <span class='int'>1000</span>
  <span class='id identifier rubyid_lock_ttl'>lock_ttl</span> <span class='op'>=</span> <span class='ivar'>@lock_timeout</span> <span class='kw'>if</span> <span class='id identifier rubyid_lock_ttl'>lock_ttl</span> <span class='op'>&lt;</span> <span class='ivar'>@lock_timeout</span>
  <span class='id identifier rubyid_commit_lock'>commit_lock</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_prev_processing_status'>prev_processing_status</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='comment'># Acquire a lock to prevent other workers from executing this function.
</span>  <span class='ivar'>@semaphore</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span><span class='lparen'>(</span><span class='id identifier rubyid_commit_lock_key'>commit_lock_key</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_locked'>locked</span><span class='op'>|</span>
    <span class='kw'>return</span> <span class='symbol'>:wait</span> <span class='kw'>unless</span> <span class='id identifier rubyid_locked'>locked</span>
    <span class='comment'># Hopefully, redlock-rb will accept our pull request so we don&#39;t need this rescue block anymore
</span>    <span class='kw'>begin</span>
      <span class='id identifier rubyid_commit_lock'>commit_lock</span> <span class='op'>=</span> <span class='ivar'>@commit_lock_manager</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span><span class='lparen'>(</span><span class='id identifier rubyid_commit_lock_key'>commit_lock_key</span><span class='comma'>,</span> <span class='id identifier rubyid_lock_ttl'>lock_ttl</span><span class='rparen'>)</span>
    <span class='kw'>rescue</span> <span class='const'>Redis</span><span class='op'>::</span><span class='const'>BaseConnectionError</span>
      <span class='kw'>return</span> <span class='symbol'>:wait</span>
    <span class='kw'>end</span>
    <span class='comment'># We&#39;ll be locking API later on
</span>    <span class='id identifier rubyid_api_lock'>api_lock</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='kw'>return</span> <span class='symbol'>:wait</span> <span class='kw'>unless</span> <span class='id identifier rubyid_commit_lock'>commit_lock</span>

    <span class='id identifier rubyid_prev_processing_status'>prev_processing_status</span> <span class='op'>=</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_processing_status'>processing_status</span>
    <span class='kw'>begin</span>
      <span class='comment'># Block everybody from uploading now
</span>      <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_status'>commit_status</span> <span class='op'>=</span> <span class='symbol'>:running</span>
      <span class='comment'># Keep hanging on to the commit lock until we can commit.
</span>      <span class='kw'>while</span> <span class='id identifier rubyid_commit_lock'>commit_lock</span>
        <span class='comment'># Don&#39;t commit unless we&#39;re ready or shutting down Logstash
</span>        <span class='comment'># Grab the lock again if we managed to lose it while sleeping
</span>        <span class='kw'>unless</span> <span class='id identifier rubyid_commit_lock'>commit_lock</span>
          <span class='id identifier rubyid_commit_lock'>commit_lock</span> <span class='op'>=</span> <span class='ivar'>@commit_lock_manager</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span><span class='lparen'>(</span><span class='id identifier rubyid_commit_lock_key'>commit_lock_key</span><span class='comma'>,</span> <span class='id identifier rubyid_lock_ttl'>lock_ttl</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
        <span class='kw'>break</span> <span class='kw'>unless</span> <span class='id identifier rubyid_commit_lock'>commit_lock</span>
        <span class='comment'># Clear out the queue
</span>        <span class='id identifier rubyid_send_to_domo'>send_to_domo</span><span class='lparen'>(</span><span class='id identifier rubyid_shutdown'>shutdown</span><span class='comma'>,</span> <span class='kw'>true</span><span class='rparen'>)</span> <span class='kw'>until</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_processed?'>processed?</span><span class='lparen'>(</span><span class='id identifier rubyid_shutdown'>shutdown</span><span class='rparen'>)</span>
        <span class='comment'># Acquire a lock on the key used for the non-commit API calls so nobody goes and creates a new Stream Execution in the middle of this.
</span>        <span class='id identifier rubyid_api_lock'>api_lock</span> <span class='op'>=</span> <span class='ivar'>@commit_lock_manager</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span><span class='lparen'>(</span><span class='id identifier rubyid_lock_key'>lock_key</span><span class='comma'>,</span> <span class='ivar'>@lock_timeout</span><span class='rparen'>)</span>
        <span class='kw'>break</span> <span class='kw'>unless</span> <span class='id identifier rubyid_api_lock'>api_lock</span> <span class='kw'>and</span> <span class='id identifier rubyid_commit_lock'>commit_lock</span>
        <span class='comment'># Make sure the API lock and commit lock will last for at least the same amount of time.
</span>        <span class='kw'>if</span> <span class='id identifier rubyid_commit_lock'>commit_lock</span><span class='lbracket'>[</span><span class='symbol'>:validity</span><span class='rbracket'>]</span> <span class='op'>&lt;=</span> <span class='id identifier rubyid_api_lock'>api_lock</span><span class='lbracket'>[</span><span class='symbol'>:validity</span><span class='rbracket'>]</span>
          <span class='id identifier rubyid_commit_lock'>commit_lock</span> <span class='op'>=</span> <span class='ivar'>@commit_lock_manager</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span><span class='lparen'>(</span><span class='id identifier rubyid_commit_lock_key'>commit_lock_key</span><span class='comma'>,</span> <span class='id identifier rubyid_lock_ttl'>lock_ttl</span><span class='comma'>,</span> <span class='label'>extend:</span> <span class='id identifier rubyid_commit_lock'>commit_lock</span><span class='comma'>,</span> <span class='label'>extend_only_if_locked:</span> <span class='kw'>true</span><span class='rparen'>)</span>
        <span class='kw'>end</span>

        <span class='comment'># Validate the active Stream Execution
</span>        <span class='kw'>unless</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span>
          <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_status'>commit_status</span> <span class='op'>=</span> <span class='symbol'>:open</span>
          <span class='kw'>break</span>
        <span class='kw'>end</span>
        <span class='comment'># Do one last validation on the Stream Execution and abort if there are irregularities.
</span>        <span class='kw'>begin</span>
          <span class='id identifier rubyid_stream_execution'>stream_execution</span> <span class='op'>=</span> <span class='ivar'>@domo_client</span><span class='period'>.</span><span class='id identifier rubyid_stream_client'>stream_client</span><span class='period'>.</span><span class='id identifier rubyid_getExecution'>getExecution</span><span class='lparen'>(</span><span class='ivar'>@stream_id</span><span class='comma'>,</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span><span class='rparen'>)</span>
        <span class='kw'>rescue</span> <span class='const'>Java</span><span class='op'>::</span><span class='const'>ComDomoSdkRequest</span><span class='op'>::</span><span class='const'>RequestException</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
          <span class='id identifier rubyid_status_code'>status_code</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="LogStash::Outputs::Domo (class)">Domo</a></span></span><span class='op'>::</span><span class='const'>Client</span><span class='period'>.</span><span class='id identifier rubyid_request_error_status_code'>request_error_status_code</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='rparen'>)</span>
          <span class='kw'>if</span> <span class='id identifier rubyid_status_code'>status_code</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='kw'>or</span> <span class='id identifier rubyid_status_code'>status_code</span> <span class='op'>==</span> <span class='op'>-</span><span class='int'>1</span>
            <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>We got a status code of -1 somehow. Let&#39;s look at the exception.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                          <span class='symbol'>:exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span><span class='comma'>,</span>
                          <span class='symbol'>:status_code</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_status_code'>status_code</span><span class='comma'>,</span>
                          <span class='symbol'>:message</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span>
          <span class='kw'>end</span>
          <span class='comment'># The Execution no longer exists.
</span>          <span class='kw'>if</span> <span class='id identifier rubyid_status_code'>status_code</span> <span class='op'>==</span> <span class='int'>404</span> <span class='kw'>or</span> <span class='id identifier rubyid_status_code'>status_code</span> <span class='op'>==</span> <span class='op'>-</span><span class='int'>1</span>
            <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_status'>commit_status</span> <span class='op'>=</span> <span class='symbol'>:open</span>
            <span class='ivar'>@commit_lock_manager</span><span class='period'>.</span><span class='id identifier rubyid_unlock'>unlock</span><span class='lparen'>(</span><span class='id identifier rubyid_api_lock'>api_lock</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_api_lock'>api_lock</span>
            <span class='ivar'>@commit_lock_manager</span><span class='period'>.</span><span class='id identifier rubyid_unlock'>unlock</span><span class='lparen'>(</span><span class='id identifier rubyid_commit_lock'>commit_lock</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_commit_lock'>commit_lock</span>
            <span class='kw'>return</span> <span class='symbol'>:open</span>
          <span class='kw'>else</span>
            <span class='ivar'>@commit_lock_manager</span><span class='period'>.</span><span class='id identifier rubyid_unlock'>unlock</span><span class='lparen'>(</span><span class='id identifier rubyid_api_lock'>api_lock</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_api_lock'>api_lock</span>
            <span class='ivar'>@commit_lock_manager</span><span class='period'>.</span><span class='id identifier rubyid_unlock'>unlock</span><span class='lparen'>(</span><span class='id identifier rubyid_commit_lock'>commit_lock</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_commit_lock'>commit_lock</span>
            <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
          <span class='kw'>end</span>
        <span class='kw'>end</span>
        <span class='comment'># Abort errored out streams
</span>        <span class='kw'>if</span> <span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='period'>.</span><span class='id identifier rubyid_currentState'>currentState</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ERROR</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>or</span> <span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='period'>.</span><span class='id identifier rubyid_currentState'>currentState</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>FAILED</span><span class='tstring_end'>&quot;</span></span>
          <span class='ivar'>@domo_client</span><span class='period'>.</span><span class='id identifier rubyid_stream_client'>stream_client</span><span class='period'>.</span><span class='id identifier rubyid_abortExecution'>abortExecution</span><span class='lparen'>(</span><span class='ivar'>@stream_id</span><span class='comma'>,</span> <span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='period'>.</span><span class='id identifier rubyid_getId'>getId</span><span class='rparen'>)</span>
          <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Execution ID for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='period'>.</span><span class='id identifier rubyid_getId'>getId</span><span class='embexpr_end'>}</span><span class='tstring_content'> for Stream ID </span><span class='embexpr_beg'>#{</span><span class='ivar'>@stream_id</span><span class='embexpr_end'>}</span><span class='tstring_content'> was aborted due to an error.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                        <span class='symbol'>:stream_id</span>        <span class='op'>=&gt;</span> <span class='ivar'>@stream_id</span><span class='comma'>,</span>
                        <span class='symbol'>:dataset_id</span>       <span class='op'>=&gt;</span> <span class='ivar'>@dataset_id</span><span class='comma'>,</span>
                        <span class='symbol'>:execution_id</span>     <span class='op'>=&gt;</span> <span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='period'>.</span><span class='id identifier rubyid_getId'>getId</span><span class='comma'>,</span>
                        <span class='symbol'>:execution_state</span>  <span class='op'>=&gt;</span> <span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='period'>.</span><span class='id identifier rubyid_currentState'>currentState</span><span class='comma'>,</span>
                        <span class='symbol'>:execution</span>        <span class='op'>=&gt;</span> <span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span>
          <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_status'>commit_status</span> <span class='op'>=</span> <span class='symbol'>:failed</span>
        <span class='comment'># Commit!
</span>        <span class='kw'>elsif</span> <span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='period'>.</span><span class='id identifier rubyid_currentState'>currentState</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ACTIVE</span><span class='tstring_end'>&quot;</span></span>
          <span class='id identifier rubyid_execution_id'>execution_id</span> <span class='op'>=</span> <span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='period'>.</span><span class='id identifier rubyid_getId'>getId</span>
          <span class='comment'># Block everybody from uploading again
</span>          <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_status'>commit_status</span> <span class='op'>=</span> <span class='symbol'>:running</span>
          <span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='float'>0.5</span><span class='rparen'>)</span> <span class='comment'># Race conditions are a PITA
</span>          <span class='comment'># Start the commit
</span>          <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Beginning commit of Stream Execution </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_execution_id'>execution_id</span><span class='embexpr_end'>}</span><span class='tstring_content'> for Stream ID </span><span class='embexpr_beg'>#{</span><span class='ivar'>@stream_id</span><span class='embexpr_end'>}</span><span class='tstring_content'>.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                        <span class='symbol'>:stream_id</span>    <span class='op'>=&gt;</span> <span class='ivar'>@stream_id</span><span class='comma'>,</span>
                        <span class='symbol'>:pipeline_id</span>  <span class='op'>=&gt;</span> <span class='id identifier rubyid_pipeline_id'>pipeline_id</span><span class='comma'>,</span>
                        <span class='symbol'>:dataset_id</span>   <span class='op'>=&gt;</span> <span class='ivar'>@dataset_id</span><span class='comma'>,</span>
                        <span class='symbol'>:execution_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_execution_id'>execution_id</span><span class='comma'>,</span>
                        <span class='symbol'>:commit_rows</span>  <span class='op'>=&gt;</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_rows'>commit_rows</span><span class='comma'>,</span>
                        <span class='symbol'>:execution</span>    <span class='op'>=&gt;</span> <span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_stream_execution'>stream_execution</span> <span class='op'>=</span> <span class='const'>Concurrent</span><span class='op'>::</span><span class='const'>Future</span><span class='period'>.</span><span class='id identifier rubyid_execute'>execute</span> <span class='lbrace'>{</span> <span class='ivar'>@domo_client</span><span class='period'>.</span><span class='id identifier rubyid_stream_client'>stream_client</span><span class='period'>.</span><span class='id identifier rubyid_commitExecution'>commitExecution</span><span class='lparen'>(</span><span class='ivar'>@stream_id</span><span class='comma'>,</span> <span class='id identifier rubyid_execution_id'>execution_id</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
          <span class='kw'>until</span> <span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='period'>.</span><span class='id identifier rubyid_complete?'>complete?</span>
            <span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='float'>0.5</span><span class='rparen'>)</span>
            <span class='comment'># Keep the locks active
</span>            <span class='kw'>if</span> <span class='id identifier rubyid_commit_lock'>commit_lock</span><span class='lbracket'>[</span><span class='symbol'>:validity</span><span class='rbracket'>]</span> <span class='op'>&lt;=</span> <span class='int'>1000</span> <span class='kw'>or</span> <span class='id identifier rubyid_api_lock'>api_lock</span><span class='lbracket'>[</span><span class='symbol'>:validity</span><span class='rbracket'>]</span> <span class='op'>&lt;=</span> <span class='int'>1000</span>
              <span class='id identifier rubyid_commit_lock'>commit_lock</span> <span class='op'>=</span> <span class='ivar'>@commit_lock_manager</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span><span class='lparen'>(</span><span class='id identifier rubyid_commit_lock_key'>commit_lock_key</span><span class='comma'>,</span> <span class='id identifier rubyid_lock_ttl'>lock_ttl</span><span class='comma'>,</span> <span class='label'>extend:</span> <span class='id identifier rubyid_commit_lock'>commit_lock</span><span class='comma'>,</span> <span class='label'>extend_only_if_locked:</span> <span class='kw'>true</span><span class='rparen'>)</span>
              <span class='id identifier rubyid_api_lock'>api_lock</span> <span class='op'>=</span> <span class='ivar'>@commit_lock_manager</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span><span class='lparen'>(</span><span class='id identifier rubyid_lock_key'>lock_key</span><span class='comma'>,</span> <span class='ivar'>@lock_timeout</span><span class='comma'>,</span> <span class='label'>extend:</span> <span class='id identifier rubyid_api_lock'>api_lock</span><span class='comma'>,</span> <span class='label'>extend_only_if_locked:</span> <span class='kw'>true</span><span class='rparen'>)</span>
            <span class='kw'>end</span>
          <span class='kw'>end</span>

          <span class='id identifier rubyid_stream_execution'>stream_execution</span> <span class='op'>=</span> <span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span>
          <span class='comment'># Wait until the commit is actually done processing
</span>          <span class='kw'>while</span> <span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='op'>&amp;.</span><span class='id identifier rubyid_currentState'>currentState</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ACTIVE</span><span class='tstring_end'>&quot;</span></span>
            <span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='float'>0.5</span><span class='rparen'>)</span>
            <span class='comment'># Attempt to grab the lock again if we lost it
</span>            <span class='id identifier rubyid_commit_lock'>commit_lock</span> <span class='op'>=</span> <span class='ivar'>@commit_lock_manager</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span><span class='lparen'>(</span><span class='id identifier rubyid_commit_lock_key'>commit_lock_key</span><span class='comma'>,</span> <span class='id identifier rubyid_lock_ttl'>lock_ttl</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_commit_lock'>commit_lock</span>
            <span class='comment'># Give up if we still can&#39;t get it
</span>            <span class='kw'>return</span> <span class='symbol'>:wait</span> <span class='kw'>unless</span> <span class='id identifier rubyid_commit_lock'>commit_lock</span>
            <span class='comment'># Keep the locks active
</span>            <span class='id identifier rubyid_commit_lock'>commit_lock</span> <span class='op'>=</span> <span class='ivar'>@commit_lock_manager</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span><span class='lparen'>(</span><span class='id identifier rubyid_commit_lock_key'>commit_lock_key</span><span class='comma'>,</span> <span class='id identifier rubyid_lock_ttl'>lock_ttl</span><span class='comma'>,</span> <span class='label'>extend:</span> <span class='id identifier rubyid_commit_lock'>commit_lock</span><span class='comma'>,</span> <span class='label'>extend_only_if_locked:</span> <span class='kw'>true</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_commit_lock'>commit_lock</span><span class='lbracket'>[</span><span class='symbol'>:validity</span><span class='rbracket'>]</span> <span class='op'>&lt;=</span> <span class='int'>1000</span>
            <span class='id identifier rubyid_api_lock'>api_lock</span> <span class='op'>=</span> <span class='ivar'>@commit_lock_manager</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span><span class='lparen'>(</span><span class='id identifier rubyid_lock_key'>lock_key</span><span class='comma'>,</span> <span class='ivar'>@lock_timeout</span><span class='comma'>,</span> <span class='label'>extend:</span> <span class='id identifier rubyid_api_lock'>api_lock</span><span class='comma'>,</span> <span class='label'>extend_only_if_locked:</span> <span class='kw'>true</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_api_lock'>api_lock</span> <span class='kw'>and</span> <span class='id identifier rubyid_api_lock'>api_lock</span><span class='lbracket'>[</span><span class='symbol'>:validity</span><span class='rbracket'>]</span> <span class='op'>&lt;=</span> <span class='int'>1000</span>
            <span class='comment'># Update the StreamExecution from the API.
</span>            <span class='kw'>begin</span>
              <span class='id identifier rubyid_stream_execution'>stream_execution</span> <span class='op'>=</span> <span class='ivar'>@domo_client</span><span class='period'>.</span><span class='id identifier rubyid_stream_client'>stream_client</span><span class='period'>.</span><span class='id identifier rubyid_getExecution'>getExecution</span><span class='lparen'>(</span><span class='ivar'>@stream_id</span><span class='comma'>,</span> <span class='id identifier rubyid_execution_id'>execution_id</span><span class='rparen'>)</span>
            <span class='kw'>rescue</span> <span class='const'>Java</span><span class='op'>::</span><span class='const'>ComDomoSdkRequest</span><span class='op'>::</span><span class='const'>RequestException</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
              <span class='comment'># Almost every exception means we&#39;re done.
</span>              <span class='id identifier rubyid_status_code'>status_code</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="LogStash::Outputs::Domo (class)">Domo</a></span></span><span class='op'>::</span><span class='const'>Client</span><span class='period'>.</span><span class='id identifier rubyid_request_error_status_code'>request_error_status_code</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='rparen'>)</span>
              <span class='kw'>if</span> <span class='id identifier rubyid_status_code'>status_code</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='kw'>or</span> <span class='id identifier rubyid_status_code'>status_code</span> <span class='op'>==</span> <span class='op'>-</span><span class='int'>1</span>
                <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>We got a status code of -1 somehow. Let&#39;s look at the exception.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                              <span class='symbol'>:exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span><span class='comma'>,</span>
                              <span class='symbol'>:status_code</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_status_code'>status_code</span><span class='comma'>,</span>
                              <span class='symbol'>:message</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span>
              <span class='kw'>end</span>
              <span class='kw'>if</span> <span class='id identifier rubyid_status_code'>status_code</span> <span class='op'>==</span> <span class='int'>404</span> <span class='kw'>or</span> <span class='id identifier rubyid_status_code'>status_code</span> <span class='op'>&lt;</span> <span class='int'>400</span> <span class='kw'>or</span> <span class='id identifier rubyid_status_code'>status_code</span> <span class='op'>&gt;=</span> <span class='int'>500</span>
                <span class='kw'>break</span>
              <span class='kw'>else</span>
                <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
              <span class='kw'>end</span>
            <span class='kw'>end</span>
          <span class='kw'>end</span>
          <span class='comment'># Mark the queue as successfully committed.
</span>          <span class='id identifier rubyid_commit_rows'>commit_rows</span> <span class='op'>=</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_rows'>commit_rows</span>
          <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit'>commit</span>
          <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Committed Execution ID for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_execution_id'>execution_id</span><span class='embexpr_end'>}</span><span class='tstring_content'> for Stream ID </span><span class='embexpr_beg'>#{</span><span class='ivar'>@stream_id</span><span class='embexpr_end'>}</span><span class='tstring_content'>.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                        <span class='symbol'>:stream_id</span>        <span class='op'>=&gt;</span> <span class='ivar'>@stream_id</span><span class='comma'>,</span>
                        <span class='symbol'>:pipeline_id</span>      <span class='op'>=&gt;</span> <span class='id identifier rubyid_pipeline_id'>pipeline_id</span><span class='comma'>,</span>
                        <span class='symbol'>:dataset_id</span>       <span class='op'>=&gt;</span> <span class='ivar'>@dataset_id</span><span class='comma'>,</span>
                        <span class='symbol'>:execution_id</span>     <span class='op'>=&gt;</span> <span class='id identifier rubyid_execution_id'>execution_id</span><span class='comma'>,</span>
                        <span class='symbol'>:commit_rows</span>      <span class='op'>=&gt;</span> <span class='id identifier rubyid_commit_rows'>commit_rows</span><span class='comma'>,</span>
                        <span class='symbol'>:execution</span>        <span class='op'>=&gt;</span> <span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span>
        <span class='kw'>else</span>
          <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_warn'>warn</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Stream Execution ID </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='period'>.</span><span class='id identifier rubyid_getId'>getId</span><span class='embexpr_end'>}</span><span class='tstring_content'> for Stream ID </span><span class='embexpr_beg'>#{</span><span class='ivar'>@stream_id</span><span class='embexpr_end'>}</span><span class='tstring_content'> could not be committed or aborted because its state is </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='period'>.</span><span class='id identifier rubyid_currentState'>currentState</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                       <span class='symbol'>:stream_id</span>        <span class='op'>=&gt;</span> <span class='ivar'>@stream_id</span><span class='comma'>,</span>
                       <span class='symbol'>:pipeline_id</span>      <span class='op'>=&gt;</span> <span class='id identifier rubyid_pipeline_id'>pipeline_id</span><span class='comma'>,</span>
                       <span class='symbol'>:dataset_id</span>       <span class='op'>=&gt;</span> <span class='ivar'>@dataset_id</span><span class='comma'>,</span>
                       <span class='symbol'>:commit_rows</span>      <span class='op'>=&gt;</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_rows'>commit_rows</span><span class='comma'>,</span>
                       <span class='symbol'>:execution_id</span>     <span class='op'>=&gt;</span> <span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='period'>.</span><span class='id identifier rubyid_getId'>getId</span><span class='comma'>,</span>
                       <span class='symbol'>:execution_state</span>  <span class='op'>=&gt;</span> <span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='period'>.</span><span class='id identifier rubyid_currentState'>currentState</span><span class='comma'>,</span>
                       <span class='symbol'>:execution</span>        <span class='op'>=&gt;</span> <span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span>
          <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_status'>commit_status</span> <span class='op'>=</span> <span class='symbol'>:failed</span>
        <span class='kw'>end</span>
        <span class='kw'>break</span>
      <span class='kw'>end</span>
    <span class='comment'># Make sure to unlock all the locks
</span>    <span class='kw'>ensure</span>
      <span class='ivar'>@commit_lock_manager</span><span class='period'>.</span><span class='id identifier rubyid_unlock'>unlock</span><span class='lparen'>(</span><span class='id identifier rubyid_api_lock'>api_lock</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_api_lock'>api_lock</span>
      <span class='ivar'>@commit_lock_manager</span><span class='period'>.</span><span class='id identifier rubyid_unlock'>unlock</span><span class='lparen'>(</span><span class='id identifier rubyid_commit_lock'>commit_lock</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_commit_lock'>commit_lock</span>
      <span class='comment'># Open the queue back up if the execution failed
</span>      <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_status'>commit_status</span> <span class='op'>=</span> <span class='symbol'>:open</span> <span class='kw'>if</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_status'>commit_status</span> <span class='op'>==</span> <span class='symbol'>:running</span> <span class='kw'>or</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_status'>commit_status</span> <span class='op'>==</span> <span class='symbol'>:blocked_for_commit</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_prev_processing_status'>prev_processing_status</span> <span class='op'>==</span> <span class='symbol'>:blocked_for_commit</span>
    <span class='id identifier rubyid_send_to_domo'>send_to_domo</span><span class='lparen'>(</span><span class='id identifier rubyid_shutdown'>shutdown</span><span class='rparen'>)</span> <span class='kw'>until</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_processed?'>processed?</span><span class='lparen'>(</span><span class='id identifier rubyid_shutdown'>shutdown</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_try_commit'>try_commit</span><span class='lparen'>(</span><span class='id identifier rubyid_shutdown'>shutdown</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='comment'># Return the status of the commit.
</span>  <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_status'>commit_status</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="dlq_enabled?-instance_method">
  
    #<strong>dlq_enabled?</strong>  &#x21d2; <tt>Boolean</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Checks if the Dead Letter Queue is enabled</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1194
1195
1196
1197
1198
1199
1200</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/logstash/outputs/domo.rb', line 1194</span>

<span class='kw'>def</span> <span class='id identifier rubyid_dlq_enabled?'>dlq_enabled?</span>
  <span class='comment'># Thanks Elasticsearch plugin team!
</span>  <span class='comment'># https://github.com/logstash-plugins/logstash-output-elasticsearch/blob/master/lib/logstash/outputs/elasticsearch/common.rb#L349
</span>  <span class='comment'># See more in: https://github.com/elastic/logstash/issues/8064
</span>  <span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:execution_context</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_execution_context'>execution_context</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:dlq_writer</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span>
      <span class='op'>!</span><span class='id identifier rubyid_execution_context'>execution_context</span><span class='period'>.</span><span class='id identifier rubyid_dlq_writer'>dlq_writer</span><span class='period'>.</span><span class='id identifier rubyid_inner_writer'>inner_writer</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='op'>::</span><span class='const'>LogStash</span><span class='op'>::</span><span class='const'>Util</span><span class='op'>::</span><span class='const'>DummyDeadLetterQueueWriter</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="encode_event_data-instance_method">
  
    #<strong>encode_event_data</strong>(event)  &#x21d2; <tt>String</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>CSV encode event data to pass to DOMO</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>event</span>
      
      
        <span class='type'>(<tt>LogStash::Event</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The Event to be sent to DOMO.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The CSV encoded string.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


938
939
940
941
942
943
944
945
946
947
948
949
950
951
952
953
954
955
956
957
958
959
960
961
962
963
964
965
966
967
968
969
970
971
972
973
974
975
976
977
978
979
980
981</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/logstash/outputs/domo.rb', line 938</span>

<span class='kw'>def</span> <span class='id identifier rubyid_encode_event_data'>encode_event_data</span><span class='lparen'>(</span><span class='id identifier rubyid_event'>event</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_column_names'>column_names</span> <span class='op'>=</span> <span class='ivar'>@dataset_columns</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_col'>col</span><span class='op'>|</span> <span class='id identifier rubyid_col'>col</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
  <span class='id identifier rubyid_encode_options'>encode_options</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='symbol'>:headers</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_column_names'>column_names</span><span class='comma'>,</span>
      <span class='symbol'>:write_headers</span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
      <span class='symbol'>:return_headers</span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
  <span class='rbrace'>}</span>

  <span class='id identifier rubyid_csv_data'>csv_data</span> <span class='op'>=</span> <span class='const'>CSV</span><span class='period'>.</span><span class='id identifier rubyid_generate'>generate</span><span class='lparen'>(</span><span class='const'>String</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='comma'>,</span> <span class='id identifier rubyid_encode_options'>encode_options</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_csv_obj'>csv_obj</span><span class='op'>|</span>
    <span class='id identifier rubyid_data'>data</span> <span class='op'>=</span> <span class='id identifier rubyid_event'>event</span><span class='period'>.</span><span class='id identifier rubyid_to_hash'>to_hash</span><span class='period'>.</span><span class='id identifier rubyid_flatten_with_path'>flatten_with_path</span>
    <span class='id identifier rubyid_data'>data</span> <span class='op'>=</span> <span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span><span class='op'>|</span> <span class='id identifier rubyid_column_names'>column_names</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span> <span class='id identifier rubyid_k'>k</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_discarded_fields'>discarded_fields</span> <span class='op'>=</span> <span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span><span class='op'>|</span> <span class='op'>!</span><span class='id identifier rubyid_column_names'>column_names</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span> <span class='id identifier rubyid_k'>k</span> <span class='rbrace'>}</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_discarded_fields'>discarded_fields</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='kw'>or</span> <span class='id identifier rubyid_discarded_fields'>discarded_fields</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&lt;=</span> <span class='int'>0</span>
      <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_warn'>warn</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The event has fields that are not present in the Domo Dataset. They will be discarded.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                   <span class='symbol'>:fields</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_discarded_fields'>discarded_fields</span><span class='comma'>,</span>
                   <span class='symbol'>:event</span>  <span class='op'>=&gt;</span> <span class='id identifier rubyid_event'>event</span><span class='rparen'>)</span>
    <span class='kw'>end</span>

    <span class='ivar'>@dataset_columns</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_col'>col</span><span class='op'>|</span>
      <span class='comment'># Just extracting this so referencing it as a key in other hashes isn&#39;t so damn awkward to read
</span>      <span class='id identifier rubyid_col_name'>col_name</span> <span class='op'>=</span> <span class='id identifier rubyid_col'>col</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span>
      <span class='comment'># Set the Upload timestamp if we&#39;re into that sort of thing.
</span>      <span class='kw'>if</span> <span class='ivar'>@upload_timestamp_field</span> <span class='kw'>and</span> <span class='id identifier rubyid_col_name'>col_name</span> <span class='op'>==</span> <span class='ivar'>@upload_timestamp_field</span>
        <span class='id identifier rubyid_data'>data</span><span class='lbracket'>[</span><span class='id identifier rubyid_col_name'>col_name</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_utc'>utc</span><span class='period'>.</span><span class='id identifier rubyid_to_datetime'>to_datetime</span>
      <span class='kw'>elsif</span> <span class='ivar'>@partition_field</span> <span class='kw'>and</span> <span class='id identifier rubyid_col_name'>col_name</span> <span class='op'>==</span> <span class='ivar'>@partition_field</span>
        <span class='id identifier rubyid_data'>data</span><span class='lbracket'>[</span><span class='id identifier rubyid_col_name'>col_name</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_utc'>utc</span><span class='period'>.</span><span class='id identifier rubyid_to_date'>to_date</span>
      <span class='comment'># Set the column value to null if it&#39;s missing from the event data
</span>      <span class='kw'>elsif</span> <span class='op'>!</span><span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span> <span class='id identifier rubyid_col_name'>col_name</span>
        <span class='id identifier rubyid_data'>data</span><span class='lbracket'>[</span><span class='id identifier rubyid_col_name'>col_name</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>nil</span>
      <span class='kw'>end</span>

      <span class='comment'># Make sure the type matches what Domo expects.
</span>      <span class='kw'>if</span> <span class='ivar'>@type_check</span>
        <span class='kw'>unless</span> <span class='id identifier rubyid_data'>data</span><span class='lbracket'>[</span><span class='id identifier rubyid_col_name'>col_name</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='kw'>or</span> <span class='id identifier rubyid_ruby_domo_type_match?'>ruby_domo_type_match?</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='lbracket'>[</span><span class='id identifier rubyid_col_name'>col_name</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_col'>col</span><span class='lbracket'>[</span><span class='symbol'>:type</span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="Domo/ColumnTypeError.html" title="LogStash::Outputs::Domo::ColumnTypeError (class)">ColumnTypeError</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Domo/ColumnTypeError.html#initialize-instance_method" title="LogStash::Outputs::Domo::ColumnTypeError#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_col_name'>col_name</span><span class='comma'>,</span> <span class='id identifier rubyid_col'>col</span><span class='lbracket'>[</span><span class='symbol'>:type</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_data'>data</span><span class='lbracket'>[</span><span class='id identifier rubyid_col_name'>col_name</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='comma'>,</span> <span class='id identifier rubyid_data'>data</span><span class='lbracket'>[</span><span class='id identifier rubyid_col_name'>col_name</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_data'>data</span> <span class='op'>=</span> <span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_sort_by'>sort_by</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid__'>_</span><span class='op'>|</span> <span class='id identifier rubyid_column_names'>column_names</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='id identifier rubyid_k'>k</span><span class='rparen'>)</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span>
    <span class='id identifier rubyid_csv_obj'>csv_obj</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_values'>values</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_csv_data'>csv_data</span><span class='period'>.</span><span class='id identifier rubyid_strip'>strip</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="get_queue-instance_method">
  
    #<strong>get_queue</strong>  &#x21d2; <tt><span class='object_link'><a href="../../Domo/Queue/Redis/JobQueue.html" title="Domo::Queue::Redis::JobQueue (class)">Domo::Queue::Redis::JobQueue</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Get the active queue</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../../Domo/Queue/Redis/JobQueue.html" title="Domo::Queue::Redis::JobQueue (class)">Domo::Queue::Redis::JobQueue</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


329
330
331
332
333</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/logstash/outputs/domo.rb', line 329</span>

<span class='kw'>def</span> <span class='id identifier rubyid_get_queue'>get_queue</span>
  <span class='kw'>return</span> <span class='ivar'>@queue</span> <span class='kw'>unless</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>

  <span class='const'><span class='object_link'><a href="" title="LogStash::Outputs::Domo (class)">Domo</a></span></span><span class='op'>::</span><span class='const'>Queue</span><span class='op'>::</span><span class='const'>Redis</span><span class='op'>::</span><span class='const'>JobQueue</span><span class='period'>.</span><span class='id identifier rubyid_active_queue'>active_queue</span><span class='lparen'>(</span><span class='ivar'>@redis_client</span><span class='comma'>,</span> <span class='ivar'>@dataset_id</span><span class='comma'>,</span> <span class='ivar'>@stream_id</span><span class='comma'>,</span> <span class='id identifier rubyid_pipeline_id'>pipeline_id</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="lock_hosts-instance_method">
  
    #<strong>lock_hosts</strong>(lock_hosts, lock_ports, lock_passwords)  &#x21d2; <tt>Array&lt;Redis&gt;</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Builds an array of Redis clients out of the plugin&#39;s configuration
parameters for distributed locking</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array&lt;Redis&gt;</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1110
1111
1112
1113
1114
1115
1116
1117
1118
1119
1120</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/logstash/outputs/domo.rb', line 1110</span>

<span class='kw'>def</span> <span class='id identifier rubyid_lock_hosts'>lock_hosts</span><span class='lparen'>(</span><span class='id identifier rubyid_lock_hosts'>lock_hosts</span><span class='comma'>,</span> <span class='id identifier rubyid_lock_ports'>lock_ports</span><span class='comma'>,</span> <span class='id identifier rubyid_lock_passwords'>lock_passwords</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_lock_servers'>lock_servers</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='id identifier rubyid_lock_hosts'>lock_hosts</span><span class='period'>.</span><span class='id identifier rubyid_each_with_index'>each_with_index</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
    <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='id identifier rubyid_lock_ports'>lock_ports</span><span class='period'>.</span><span class='id identifier rubyid_fetch'>fetch</span><span class='lparen'>(</span><span class='id identifier rubyid_i'>i</span><span class='comma'>,</span> <span class='int'>6379</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_password'>password</span> <span class='op'>=</span> <span class='id identifier rubyid_lock_passwords'>lock_passwords</span><span class='period'>.</span><span class='id identifier rubyid_fetch'>fetch</span><span class='lparen'>(</span><span class='id identifier rubyid_i'>i</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rparen'>)</span>

    <span class='id identifier rubyid_lock_servers'>lock_servers</span> <span class='op'>&lt;&lt;</span> <span class='const'>Redis</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>host</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>port</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_port'>port</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>password</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_password'>password</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_lock_servers'>lock_servers</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="lock_hosts_tls_opts-instance_method">
  
    #<strong>lock_hosts_tls_opts</strong>(lock_hosts)  &#x21d2; <tt>Array&lt;Redis&gt;</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Loop through lock_hosts from the configuration and add TLS options if
they&#39;re using rediss</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>lock_hosts</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array&lt;Redis&gt;</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1163
1164
1165
1166
1167
1168
1169
1170
1171</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/logstash/outputs/domo.rb', line 1163</span>

<span class='kw'>def</span> <span class='id identifier rubyid_lock_hosts_tls_opts'>lock_hosts_tls_opts</span><span class='lparen'>(</span><span class='id identifier rubyid_lock_hosts'>lock_hosts</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_lock_hosts'>lock_hosts</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_host'>host</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_host'>host</span><span class='period'>.</span><span class='id identifier rubyid_start_with?'>start_with?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>rediss</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
      <span class='const'>Redis</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='label'>ssl_params:</span> <span class='lbrace'>{</span><span class='symbol'>:verify_mode</span> <span class='op'>=&gt;</span> <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>SSL</span><span class='op'>::</span><span class='const'>VERIFY_NONE</span><span class='rbrace'>}</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='const'>Redis</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='id identifier rubyid_host'>host</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="merge_pending_jobs!-instance_method">
  
    #<strong>merge_pending_jobs!</strong>(data, shutdown = false)  &#x21d2; <tt>Array</tt><sup>?</sup>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Merge the data in all of our pending jobs If we&#39;re shutting down or the
size of the merged data exceeds upload_min_batch_size, then the data will
be returned. Otherwise, the new job will be thrown back into the pending
queue until it is ready, and nil will be returned.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>data</span>
      
      
        <span class='type'>(<tt>Array&lt;String&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The CSV data to upload to DOMO.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>shutdown</span>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>false</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Indicates that Logstash is shutting down.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array</tt>, <tt>nil</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1006
1007
1008
1009
1010
1011
1012
1013
1014
1015
1016
1017
1018
1019
1020
1021
1022
1023
1024
1025
1026
1027
1028
1029
1030
1031
1032
1033
1034
1035
1036</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/logstash/outputs/domo.rb', line 1006</span>

<span class='kw'>def</span> <span class='id identifier rubyid_merge_pending_jobs!'>merge_pending_jobs!</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='comma'>,</span> <span class='id identifier rubyid_shutdown'>shutdown</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_merged_data'>merged_data</span> <span class='op'>=</span> <span class='id identifier rubyid_data'>data</span>
  <span class='id identifier rubyid_rows_start'>rows_start</span> <span class='op'>=</span> <span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span>
  <span class='kw'>begin</span>
    <span class='comment'># Grab a lock so other workers don&#39;t fight over grabbing these jobs
</span>    <span class='ivar'>@commit_lock_manager</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span><span class='lparen'>(</span><span class='id identifier rubyid_pending_lock_key'>pending_lock_key</span><span class='comma'>,</span> <span class='ivar'>@lock_timeout</span><span class='op'>*</span><span class='int'>2</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_locked'>locked</span><span class='op'>|</span>
      <span class='kw'>return</span> <span class='id identifier rubyid_merged_data'>merged_data</span> <span class='kw'>unless</span> <span class='id identifier rubyid_locked'>locked</span>

      <span class='kw'>while</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_pending_jobs'>pending_jobs</span><span class='period'>.</span><span class='id identifier rubyid_merge_ready?'>merge_ready?</span><span class='lparen'>(</span><span class='id identifier rubyid_rows_start'>rows_start</span><span class='comma'>,</span> <span class='ivar'>@upload_min_batch_size</span><span class='comma'>,</span> <span class='id identifier rubyid_shutdown'>shutdown</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_merged_data'>merged_data</span> <span class='op'>=</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_pending_jobs'>pending_jobs</span><span class='period'>.</span><span class='id identifier rubyid_reduce'>reduce</span><span class='lparen'>(</span><span class='id identifier rubyid_merged_data'>merged_data</span><span class='comma'>,</span> <span class='ivar'>@upload_min_batch_size</span><span class='comma'>,</span> <span class='id identifier rubyid_shutdown'>shutdown</span><span class='rparen'>)</span>
        <span class='kw'>break</span> <span class='kw'>if</span> <span class='id identifier rubyid_merged_data'>merged_data</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>==</span> <span class='id identifier rubyid_rows_start'>rows_start</span>

      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_merged_data'>merged_data</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_rows_start'>rows_start</span>
      <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Merged pending jobs</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                    <span class='symbol'>:stream_id</span>         <span class='op'>=&gt;</span> <span class='ivar'>@stream_id</span><span class='comma'>,</span>
                    <span class='symbol'>:execution_id</span>      <span class='op'>=&gt;</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span><span class='comma'>,</span>
                    <span class='symbol'>:pipeline_id</span>       <span class='op'>=&gt;</span> <span class='id identifier rubyid_pipeline_id'>pipeline_id</span><span class='comma'>,</span>
                    <span class='symbol'>:rows_start</span>        <span class='op'>=&gt;</span> <span class='id identifier rubyid_rows_start'>rows_start</span><span class='comma'>,</span>
                    <span class='symbol'>:rows_pending</span>      <span class='op'>=&gt;</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_pending_jobs'>pending_jobs</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='comma'>,</span>
                    <span class='symbol'>:rows_merged</span>       <span class='op'>=&gt;</span> <span class='id identifier rubyid_merged_data'>merged_data</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>rescue</span> <span class='const'>Redlock</span><span class='op'>::</span><span class='const'>LockError</span>
    <span class='comment'># Do nothing
</span>  <span class='kw'>rescue</span> <span class='const'>Redis</span><span class='op'>::</span><span class='const'>BaseConnectionError</span>
    <span class='comment'># Do nothing
</span>  <span class='kw'>end</span>

  <span class='id identifier rubyid_merged_data'>merged_data</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="multi_receive-instance_method">
  
    #<strong>multi_receive</strong>(events)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/logstash/outputs/domo.rb', line 336</span>

<span class='kw'>def</span> <span class='id identifier rubyid_multi_receive'>multi_receive</span><span class='lparen'>(</span><span class='id identifier rubyid_events'>events</span><span class='rparen'>)</span>
  <span class='comment'># Get the current queue
</span>  <span class='ivar'>@queue</span> <span class='op'>=</span> <span class='id identifier rubyid_get_queue'>get_queue</span>
  <span class='comment'># LogStash::SHUTDOWN events will set this to true
</span>  <span class='id identifier rubyid_shutdown'>shutdown</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='comment'># The Array of CSV strings to associate with upload job data.
</span>  <span class='id identifier rubyid_data'>data</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='comment'># When using upload_max_batch_size we keep track of the number of batches generated from the provided events
</span>  <span class='id identifier rubyid_num_batches'>num_batches</span> <span class='op'>=</span> <span class='int'>1</span>
  <span class='comment'># Loop through the incoming events, encode them, add the encoded data to the data Array, and parcel out jobs.
</span>  <span class='id identifier rubyid_events'>events</span><span class='period'>.</span><span class='id identifier rubyid_each_with_index'>each_with_index</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_event'>event</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_event'>event</span> <span class='op'>==</span> <span class='const'>LogStash</span><span class='op'>::</span><span class='const'>SHUTDOWN</span>
      <span class='id identifier rubyid_shutdown'>shutdown</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='kw'>break</span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_event'>event</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>LogStash</span><span class='op'>::</span><span class='const'>Event</span>
      <span class='comment'># Encode the Event data
</span>      <span class='kw'>begin</span>
        <span class='id identifier rubyid_encoded_event'>encoded_event</span> <span class='op'>=</span> <span class='id identifier rubyid_encode_event_data'>encode_event_data</span><span class='lparen'>(</span><span class='id identifier rubyid_event'>event</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_data'>data</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_encoded_event'>encoded_event</span>
      <span class='comment'># Reject the invalid event and send it to the DLQ if it&#39;s enabled.
</span>      <span class='kw'>rescue</span> <span class='const'><span class='object_link'><a href="Domo/ColumnTypeError.html" title="LogStash::Outputs::Domo::ColumnTypeError (class)">ColumnTypeError</a></span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
        <span class='ivar'>@dlq_writer</span><span class='period'>.</span><span class='id identifier rubyid_write'>write</span><span class='lparen'>(</span><span class='id identifier rubyid_event'>event</span><span class='comma'>,</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_log_entry'>log_entry</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@dlq_writer</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
        <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_log_entry'>log_entry</span><span class='comma'>,</span>
                      <span class='symbol'>:value</span>       <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_val'>val</span><span class='comma'>,</span>
                      <span class='symbol'>:column_name</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_col_name'>col_name</span><span class='comma'>,</span>
                      <span class='symbol'>:event</span>       <span class='op'>=&gt;</span> <span class='id identifier rubyid_event'>event</span><span class='period'>.</span><span class='id identifier rubyid_to_hash'>to_hash</span><span class='comma'>,</span>
                      <span class='symbol'>:exception</span>   <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='comment'># Spamming events seems to get us to this point during/after restarts (on dev at least)
</span>    <span class='kw'>elsif</span> <span class='id identifier rubyid_event'>event</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Array</span>
      <span class='id identifier rubyid_data'>data</span> <span class='op'>+=</span> <span class='id identifier rubyid_event'>event</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_e'>e</span><span class='op'>|</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>LogStash</span><span class='op'>::</span><span class='const'>Event</span>
          <span class='kw'>begin</span>
            <span class='id identifier rubyid_encode_event_data'>encode_event_data</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='rparen'>)</span>
          <span class='kw'>rescue</span> <span class='const'><span class='object_link'><a href="Domo/ColumnTypeError.html" title="LogStash::Outputs::Domo::ColumnTypeError (class)">ColumnTypeError</a></span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_ex'>ex</span>
            <span class='ivar'>@dlq_writer</span><span class='period'>.</span><span class='id identifier rubyid_write'>write</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='id identifier rubyid_ex'>ex</span><span class='period'>.</span><span class='id identifier rubyid_log_entry'>log_entry</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@dlq_writer</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
            <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span><span class='lparen'>(</span><span class='id identifier rubyid_ex'>ex</span><span class='period'>.</span><span class='id identifier rubyid_log_entry'>log_entry</span><span class='comma'>,</span>
                          <span class='symbol'>:value</span>       <span class='op'>=&gt;</span> <span class='id identifier rubyid_ex'>ex</span><span class='period'>.</span><span class='id identifier rubyid_val'>val</span><span class='comma'>,</span>
                          <span class='symbol'>:column_name</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_ex'>ex</span><span class='period'>.</span><span class='id identifier rubyid_col_name'>col_name</span><span class='comma'>,</span>
                          <span class='symbol'>:event</span>       <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_to_hash'>to_hash</span><span class='comma'>,</span>
                          <span class='symbol'>:exception</span>   <span class='op'>=&gt;</span> <span class='id identifier rubyid_ex'>ex</span><span class='rparen'>)</span>
          <span class='kw'>end</span>
        <span class='kw'>elsif</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>String</span>
          <span class='id identifier rubyid_e'>e</span> <span class='kw'>if</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>,</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>==</span> <span class='ivar'>@dataset_columns</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='comment'># Carve out Job batches if we have a maximum batch size.
</span>    <span class='kw'>if</span> <span class='ivar'>@upload_max_batch_size</span> <span class='op'>&gt;</span> <span class='int'>0</span> <span class='kw'>and</span> <span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>+</span> <span class='int'>1</span> <span class='op'>&gt;=</span> <span class='ivar'>@upload_max_batch_size</span> <span class='op'>*</span> <span class='id identifier rubyid_num_batches'>num_batches</span>
      <span class='id identifier rubyid_job'>job</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="LogStash::Outputs::Domo (class)">Domo</a></span></span><span class='op'>::</span><span class='const'>Queue</span><span class='op'>::</span><span class='const'>Job</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='comma'>,</span> <span class='ivar'>@upload_min_batch_size</span><span class='rparen'>)</span>
      <span class='ivar'>@queue</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_job'>job</span>
      <span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_clear'>clear</span>
      <span class='id identifier rubyid_num_batches'>num_batches</span> <span class='op'>+=</span> <span class='int'>1</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='comment'># Merge pending jobs with our data
</span>  <span class='id identifier rubyid_data'>data</span> <span class='op'>=</span> <span class='id identifier rubyid_merge_pending_jobs!'>merge_pending_jobs!</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='comma'>,</span> <span class='id identifier rubyid_shutdown'>shutdown</span><span class='rparen'>)</span>
  <span class='comment'># Only make a job if we have data
</span>  <span class='kw'>unless</span> <span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&lt;=</span> <span class='int'>0</span>
    <span class='id identifier rubyid_job'>job</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="LogStash::Outputs::Domo (class)">Domo</a></span></span><span class='op'>::</span><span class='const'>Queue</span><span class='op'>::</span><span class='const'>Job</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='comma'>,</span> <span class='ivar'>@upload_min_batch_size</span><span class='rparen'>)</span>
    <span class='comment'># Put incomplete jobs in the pending queue
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>==</span> <span class='symbol'>:incomplete</span> <span class='kw'>and</span> <span class='op'>!</span><span class='id identifier rubyid_shutdown'>shutdown</span>
      <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_pending_jobs'>pending_jobs</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_data'>data</span>
      <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_trace'>trace</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Putting job in pending queue</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                    <span class='symbol'>:stream_id</span>         <span class='op'>=&gt;</span> <span class='ivar'>@stream_id</span><span class='comma'>,</span>
                    <span class='symbol'>:execution_id</span>      <span class='op'>=&gt;</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span><span class='comma'>,</span>
                    <span class='symbol'>:pipeline_id</span>       <span class='op'>=&gt;</span> <span class='id identifier rubyid_pipeline_id'>pipeline_id</span><span class='comma'>,</span>
                    <span class='symbol'>:rows_pending</span>      <span class='op'>=&gt;</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_pending_jobs'>pending_jobs</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='comma'>,</span>
                    <span class='symbol'>:job</span>               <span class='op'>=&gt;</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_to_hash'>to_hash</span><span class='lparen'>(</span><span class='kw'>true</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='comment'># Everybody else goes to the main queue
</span>    <span class='kw'>else</span>
      <span class='ivar'>@queue</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_job'>job</span>
      <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Added job to the main queue</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                    <span class='symbol'>:stream_id</span>         <span class='op'>=&gt;</span> <span class='ivar'>@stream_id</span><span class='comma'>,</span>
                    <span class='symbol'>:execution_id</span>      <span class='op'>=&gt;</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span><span class='comma'>,</span>
                    <span class='symbol'>:pipeline_id</span>       <span class='op'>=&gt;</span> <span class='id identifier rubyid_pipeline_id'>pipeline_id</span><span class='comma'>,</span>
                    <span class='symbol'>:job</span>               <span class='op'>=&gt;</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_to_hash'>to_hash</span><span class='lparen'>(</span><span class='kw'>true</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='comment'># If the queue is empty, we&#39;re not shutting down, we&#39;re not ready to commit, and we have no data to add, give up
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='kw'>or</span> <span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&lt;=</span> <span class='int'>0</span>
    <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_shutdown'>shutdown</span> <span class='kw'>or</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_unprocessed?'>unprocessed?</span><span class='lparen'>(</span><span class='id identifier rubyid_shutdown'>shutdown</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='comment'># Process the queue
</span>  <span class='id identifier rubyid_send_to_domo'>send_to_domo</span><span class='lparen'>(</span><span class='id identifier rubyid_shutdown'>shutdown</span><span class='rparen'>)</span> <span class='kw'>until</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_processed?'>processed?</span><span class='lparen'>(</span><span class='id identifier rubyid_shutdown'>shutdown</span><span class='rparen'>)</span>
  <span class='comment'># Commit if we&#39;re ready
</span>  <span class='id identifier rubyid_try_commit'>try_commit</span><span class='lparen'>(</span><span class='id identifier rubyid_shutdown'>shutdown</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="openssl_opt_from_string-instance_method">
  
    #<strong>openssl_opt_from_string</strong>(val)  &#x21d2; <tt>Integer</tt>, <tt>String</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Figure out which OpenSSL::SSL::VERIFY constant matches with a string on the
config.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>val</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Integer</tt>, <tt>String</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1127
1128
1129
1130
1131
1132
1133
1134
1135
1136
1137
1138
1139
1140</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/logstash/outputs/domo.rb', line 1127</span>

<span class='kw'>def</span> <span class='id identifier rubyid_openssl_opt_from_string'>openssl_opt_from_string</span><span class='lparen'>(</span><span class='id identifier rubyid_val'>val</span><span class='rparen'>)</span>
  <span class='kw'>case</span> <span class='id identifier rubyid_val'>val</span>
  <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>VERIFY_NONE</span><span class='tstring_end'>&#39;</span></span>
    <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>SSL</span><span class='op'>::</span><span class='const'>VERIFY_NONE</span>
  <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>VERIFY_PEER</span><span class='tstring_end'>&#39;</span></span>
    <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>SSL</span><span class='op'>::</span><span class='const'>VERIFY_PEER</span>
  <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>VERIFY_FAIL_IF_NO_PEER_CERT</span><span class='tstring_end'>&#39;</span></span>
    <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>SSL</span><span class='op'>::</span><span class='const'>VERIFY_FAIL_IF_NO_PEER_CERT</span>
  <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>VERIFY_CLIENT_ONCE</span><span class='tstring_end'>&#39;</span></span>
    <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>SSL</span><span class='op'>::</span><span class='const'>VERIFY_CLIENT_ONCE</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_val'>val</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="recursive_symbolize-instance_method">
  
    #<strong>recursive_symbolize</strong>(obj)  &#x21d2; <tt>Hash</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Symbol all keys in a hash, as well as keys from embedded hashes.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>obj</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1147
1148
1149
1150
1151
1152
1153
1154
1155
1156</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/logstash/outputs/domo.rb', line 1147</span>

<span class='kw'>def</span> <span class='id identifier rubyid_recursive_symbolize'>recursive_symbolize</span><span class='lparen'>(</span><span class='id identifier rubyid_obj'>obj</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_obj'>obj</span><span class='period'>.</span><span class='id identifier rubyid_reduce'>reduce</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_memo'>memo</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='rparen'>)</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_v'>v</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Hash</span>
      <span class='id identifier rubyid_memo'>memo</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_recursive_symbolize'>recursive_symbolize</span><span class='lparen'>(</span><span class='id identifier rubyid_v'>v</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_memo'>memo</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_openssl_opt_from_string'>openssl_opt_from_string</span><span class='lparen'>(</span><span class='id identifier rubyid_v'>v</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_memo'>memo</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="redlock_retry_count-instance_method">
  
    #<strong>redlock_retry_count</strong>(retry_delay = 200, minimum_retry_count = 3)  &#x21d2; <tt>Integer</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Calculates an acceptable retry count for trying to acquiring a distributed
lock. The default values for the parameters match the defaults in the
current version of redlock.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>retry_delay</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>200</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>The delay between retries (ms).</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>minimum_retry_count</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>3</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>The smallest number of allowable retries.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The number of times redlock can retry acquiring a lock.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1045
1046
1047
1048
1049
1050
1051
1052
1053</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/logstash/outputs/domo.rb', line 1045</span>

<span class='kw'>def</span> <span class='id identifier rubyid_redlock_retry_count'>redlock_retry_count</span><span class='lparen'>(</span><span class='id identifier rubyid_retry_delay'>retry_delay</span><span class='op'>=</span><span class='int'>200</span><span class='comma'>,</span> <span class='id identifier rubyid_minimum_retry_count'>minimum_retry_count</span><span class='op'>=</span><span class='int'>3</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='ivar'>@lock_timeout</span> <span class='op'>&lt;</span> <span class='int'>1000</span>
    <span class='id identifier rubyid_retry_count'>retry_count</span> <span class='op'>=</span> <span class='ivar'>@lock_timeout</span> <span class='op'>/</span> <span class='id identifier rubyid_retry_delay'>retry_delay</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_retry_count'>retry_count</span> <span class='op'>=</span> <span class='ivar'>@lock_timeout</span> <span class='op'>/</span> <span class='int'>1000</span> <span class='op'>/</span> <span class='id identifier rubyid_retry_delay'>retry_delay</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_retry_count'>retry_count</span> <span class='kw'>unless</span> <span class='id identifier rubyid_retry_count'>retry_count</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_minimum_retry_count'>minimum_retry_count</span>
  <span class='id identifier rubyid_minimum_retry_count'>minimum_retry_count</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="register-instance_method">
  
    #<strong>register</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/logstash/outputs/domo.rb', line 220</span>

<span class='kw'>def</span> <span class='id identifier rubyid_register'>register</span>
  <span class='comment'># @type [Domo::Client] A client connection to Domo&#39;s APIs.
</span>  <span class='ivar'>@domo_client</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="LogStash::Outputs::Domo (class)">Domo</a></span></span><span class='op'>::</span><span class='const'>Client</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@client_id</span><span class='comma'>,</span> <span class='ivar'>@client_secret</span><span class='comma'>,</span> <span class='ivar'>@api_host</span><span class='comma'>,</span> <span class='ivar'>@api_ssl</span><span class='comma'>,</span> <span class='const'>Java</span><span class='op'>::</span><span class='const'>ComDomoSdkRequest</span><span class='op'>::</span><span class='const'>Scope</span><span class='op'>::</span><span class='const'>DATA</span><span class='rparen'>)</span>

  <span class='comment'># @type [Domo::Queue::ThreadLockManager] The Mutex we&#39;ll be using to lock writes to @commit_thread
</span>  <span class='ivar'>@semaphore</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="LogStash::Outputs::Domo (class)">Domo</a></span></span><span class='op'>::</span><span class='const'>Queue</span><span class='op'>::</span><span class='const'>ThreadLockManager</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>

  <span class='kw'>if</span> <span class='ivar'>@upload_max_batch_size</span> <span class='op'>&gt;</span> <span class='int'>0</span> <span class='kw'>and</span> <span class='ivar'>@upload_min_batch_size</span> <span class='op'>&gt;</span> <span class='ivar'>@upload_max_batch_size</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>LogStash</span><span class='op'>::</span><span class='const'>ConfigurationError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>upload_min_batch_size cannot be larger than upload_max_batch_size</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Validate the Dataset and Stream
</span>  <span class='kw'>begin</span>
    <span class='id identifier rubyid_dataset'>dataset</span> <span class='op'>=</span> <span class='ivar'>@domo_client</span><span class='period'>.</span><span class='id identifier rubyid_dataset'>dataset</span><span class='lparen'>(</span><span class='ivar'>@dataset_id</span><span class='rparen'>)</span>
    <span class='comment'># @type [Java::ComDomoSdkStreamModel::Stream] The Domo Stream associated with our Stream ID and/or Dataset.
</span>    <span class='id identifier rubyid_stream'>stream</span> <span class='op'>=</span> <span class='ivar'>@domo_client</span><span class='period'>.</span><span class='id identifier rubyid_stream'>stream</span><span class='lparen'>(</span><span class='ivar'>@stream_id</span><span class='comma'>,</span> <span class='ivar'>@dataset_id</span><span class='comma'>,</span> <span class='kw'>false</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span> <span class='const'>Java</span><span class='op'>::</span><span class='const'>ComDomoSdkRequest</span><span class='op'>::</span><span class='const'>RequestException</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_status_code'>status_code</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="LogStash::Outputs::Domo (class)">Domo</a></span></span><span class='op'>::</span><span class='const'>Client</span><span class='period'>.</span><span class='id identifier rubyid_request_error_status_code'>request_error_status_code</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='rparen'>)</span>
    <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='symbol'>:status_code</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_status_code'>status_code</span><span class='comma'>,</span> <span class='symbol'>:dataset_id</span> <span class='op'>=&gt;</span> <span class='ivar'>@dataset_id</span><span class='comma'>,</span> <span class='symbol'>:stream_id</span> <span class='op'>=&gt;</span> <span class='ivar'>@stream_id</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>LogStash</span><span class='op'>::</span><span class='const'>ConfigurationError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Either Dataset ID </span><span class='embexpr_beg'>#{</span><span class='ivar'>@dataset_id</span><span class='embexpr_end'>}</span><span class='tstring_content'> is invalid or the Stream (</span><span class='embexpr_beg'>#{</span><span class='ivar'>@stream_id</span><span class='embexpr_end'>}</span><span class='tstring_content'>) associated with it is invalid. See error logs for more detail.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='comment'># @type [Integer] The Stream ID.
</span>  <span class='ivar'>@stream_id</span> <span class='op'>=</span> <span class='id identifier rubyid_stream'>stream</span><span class='period'>.</span><span class='id identifier rubyid_getId'>getId</span>
  <span class='comment'># @type [Array&lt;String&gt;] The columns in the Dataset
</span>  <span class='ivar'>@dataset_columns</span> <span class='op'>=</span> <span class='ivar'>@domo_client</span><span class='period'>.</span><span class='id identifier rubyid_dataset_schema_columns'>dataset_schema_columns</span><span class='lparen'>(</span><span class='id identifier rubyid_stream'>stream</span><span class='rparen'>)</span>
  <span class='comment'># Get the dead letter queue writer if it&#39;s enabled.
</span>  <span class='ivar'>@dlq_writer</span> <span class='op'>=</span> <span class='id identifier rubyid_dlq_enabled?'>dlq_enabled?</span> <span class='op'>?</span> <span class='id identifier rubyid_execution_context'>execution_context</span><span class='period'>.</span><span class='id identifier rubyid_dlq_writer'>dlq_writer</span> <span class='op'>:</span> <span class='kw'>nil</span>
  <span class='comment'># If we&#39;re setting an automatic upload timestamp, make sure the field is actually in the dataset.
</span>  <span class='kw'>if</span> <span class='ivar'>@upload_timestamp_field</span>
    <span class='id identifier rubyid_col_check'>col_check</span> <span class='op'>=</span> <span class='ivar'>@dataset_columns</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_col'>col</span><span class='op'>|</span> <span class='id identifier rubyid_col'>col</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='ivar'>@upload_timestamp_field</span> <span class='rbrace'>}</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_col_check'>col_check</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>0</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>LogStash</span><span class='op'>::</span><span class='const'>ConfigurationError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The Upload Timestamp Field named </span><span class='embexpr_beg'>#{</span><span class='ivar'>@upload_timestamp_field</span><span class='embexpr_end'>}</span><span class='tstring_content'> is not present in the Dataset&#39;s schema.</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='comment'># If we&#39;re setting a Partition ID, make sure the field is actually in the Dataset.
</span>  <span class='kw'>if</span> <span class='ivar'>@partition_field</span>
    <span class='id identifier rubyid_col_check'>col_check</span> <span class='op'>=</span> <span class='ivar'>@dataset_columns</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_col'>col</span><span class='op'>|</span> <span class='id identifier rubyid_col'>col</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='ivar'>@partition_field</span> <span class='rbrace'>}</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_col_check'>col_check</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>0</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>LogStash</span><span class='op'>::</span><span class='const'>ConfigurationError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The Partition Field named </span><span class='embexpr_beg'>#{</span><span class='ivar'>@partition_field</span><span class='embexpr_end'>}</span><span class='tstring_content'> is not present in the Dataset&#39;s schema.</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='comment'># Instantiate the redis client for the queue.
</span>  <span class='ivar'>@redis_client</span> <span class='op'>=</span> <span class='id identifier rubyid_symbolize_redis_client_args'>symbolize_redis_client_args</span><span class='lparen'>(</span><span class='ivar'>@redis_client</span><span class='rparen'>)</span>
  <span class='kw'>unless</span> <span class='ivar'>@redis_sentinels</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='ivar'>@redis_client</span><span class='lbracket'>[</span><span class='symbol'>:sentinels</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='ivar'>@redis_sentinels</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_s'>s</span><span class='op'>|</span>
      <span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='id identifier rubyid_s'>s</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>:</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='lbrace'>{</span>
          <span class='symbol'>:host</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_host'>host</span><span class='comma'>,</span>
          <span class='symbol'>:port</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_port'>port</span><span class='comma'>,</span>
      <span class='rbrace'>}</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='ivar'>@redis_client</span> <span class='op'>=</span> <span class='const'>Redis</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@redis_client</span><span class='rparen'>)</span>
  <span class='comment'># Distributed lock requires a redis queuing mechanism, among other things.
</span>  <span class='kw'>if</span> <span class='ivar'>@distributed_lock</span>
    <span class='kw'>if</span> <span class='ivar'>@lock_hosts</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='kw'>or</span> <span class='ivar'>@lock_hosts</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&lt;=</span> <span class='int'>0</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>LogStash</span><span class='op'>::</span><span class='const'>ConfigurationError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The lock_servers parameter is required when using distributed_lock</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_redlock_options'>redlock_options</span> <span class='op'>=</span> <span class='lbrace'>{</span>
        <span class='symbol'>:retry_count</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_redlock_retry_count'>redlock_retry_count</span><span class='lparen'>(</span><span class='ivar'>@lock_retry_delay</span><span class='rparen'>)</span><span class='comma'>,</span>
        <span class='symbol'>:retry_delay</span> <span class='op'>=&gt;</span> <span class='ivar'>@lock_retry_delay</span><span class='comma'>,</span>
    <span class='rbrace'>}</span>
    <span class='comment'># Add redis+tls crap if need be.
</span>    <span class='ivar'>@lock_hosts</span> <span class='op'>=</span> <span class='id identifier rubyid_lock_hosts_tls_opts'>lock_hosts_tls_opts</span><span class='lparen'>(</span><span class='ivar'>@lock_hosts</span><span class='rparen'>)</span>
    <span class='ivar'>@commit_lock_manager</span> <span class='op'>=</span> <span class='const'>Redlock</span><span class='op'>::</span><span class='const'>Client</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@lock_hosts</span><span class='comma'>,</span> <span class='id identifier rubyid_redlock_options'>redlock_options</span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='ivar'>@commit_lock_manager</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="LogStash::Outputs::Domo (class)">Domo</a></span></span><span class='op'>::</span><span class='const'>Queue</span><span class='op'>::</span><span class='const'>ThreadLockManager</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='kw'>end</span>

  <span class='ivar'>@queue</span> <span class='op'>=</span> <span class='id identifier rubyid_get_queue'>get_queue</span>
  <span class='comment'># @type [Concurrent::ScheduledTask, nil]
</span>  <span class='ivar'>@semaphore</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span><span class='lparen'>(</span><span class='id identifier rubyid_lock_key'>lock_key</span><span class='comma'>,</span> <span class='ivar'>@lock_timeout</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_locked'>locked</span><span class='op'>|</span>
    <span class='ivar'>@commit_task</span> <span class='op'>||=</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>
  <span class='comment'># Reset the commit status and possibly the Queue&#39;s execution_id after possible abnormal terminations
</span>  <span class='ivar'>@commit_lock_manager</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span><span class='lparen'>(</span><span class='id identifier rubyid_commit_lock_key'>commit_lock_key</span><span class='comma'>,</span> <span class='ivar'>@lock_timeout</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_locked'>locked</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_locked'>locked</span> <span class='kw'>and</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_status'>commit_status</span> <span class='op'>==</span> <span class='symbol'>:running</span>
      <span class='kw'>begin</span>
        <span class='kw'>if</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span>
          <span class='id identifier rubyid_stream_execution'>stream_execution</span> <span class='op'>=</span> <span class='ivar'>@domo_client</span><span class='period'>.</span><span class='id identifier rubyid_stream_client'>stream_client</span><span class='period'>.</span><span class='id identifier rubyid_getExecution'>getExecution</span><span class='lparen'>(</span><span class='ivar'>@stream_id</span><span class='comma'>,</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span><span class='rparen'>)</span>
          <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span> <span class='op'>=</span> <span class='kw'>nil</span> <span class='kw'>unless</span> <span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='op'>&amp;.</span><span class='id identifier rubyid_currentState'>currentState</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ACTIVE</span><span class='tstring_end'>&quot;</span></span>
        <span class='kw'>end</span>
      <span class='kw'>rescue</span> <span class='const'>Java</span><span class='op'>::</span><span class='const'>ComDomoSdkRequest</span><span class='op'>::</span><span class='const'>RequestException</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
        <span class='id identifier rubyid_status_code'>status_code</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="LogStash::Outputs::Domo (class)">Domo</a></span></span><span class='op'>::</span><span class='const'>Client</span><span class='period'>.</span><span class='id identifier rubyid_request_error_status_code'>request_error_status_code</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='rparen'>)</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_status_code'>status_code</span> <span class='op'>&gt;=</span> <span class='int'>400</span> <span class='kw'>and</span> <span class='id identifier rubyid_status_code'>status_code</span> <span class='op'>&lt;</span> <span class='int'>500</span>
          <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span> <span class='op'>=</span> <span class='kw'>nil</span>
        <span class='kw'>else</span>
          <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
        <span class='kw'>end</span>
      <span class='kw'>ensure</span>
        <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_processing_status'>processing_status</span> <span class='op'>=</span> <span class='symbol'>:open</span> <span class='kw'>if</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
        <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_status'>commit_status</span> <span class='op'>=</span> <span class='symbol'>:open</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='comment'># Start processing the queue if it already has jobs
</span>  <span class='comment'># This is a failsafe in case all workers on all servers stopped without committing
</span>  <span class='kw'>unless</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_processed?'>processed?</span>
    <span class='comment'># Upload any jobs that are already in the queue.
</span>    <span class='id identifier rubyid_send_to_domo'>send_to_domo</span> <span class='kw'>until</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_processed?'>processed?</span>
    <span class='comment'># Commit if we&#39;re ready
</span>    <span class='id identifier rubyid_try_commit'>try_commit</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="ruby_domo_type_match?-instance_method">
  
    #<strong>ruby_domo_type_match?</strong>(val, domo_column_type)  &#x21d2; <tt>Boolean</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Takes a given value and returns a boolean indicating if its type matches
the corresponding Domo column.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>val</span>
      
      
        <span class='type'>(<tt>Object</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The object to inspect.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>domo_column_type</span>
      
      
        <span class='type'>(<tt>Java::ComDomoSdkDatasetsModel::ColumnType</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The Domo column type.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Whether or not the types match.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1061
1062
1063
1064
1065
1066
1067
1068
1069
1070
1071
1072
1073
1074
1075
1076
1077
1078
1079
1080
1081
1082
1083
1084
1085
1086
1087
1088
1089
1090
1091
1092
1093
1094
1095
1096
1097
1098
1099
1100
1101
1102
1103
1104</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/logstash/outputs/domo.rb', line 1061</span>

<span class='kw'>def</span> <span class='id identifier rubyid_ruby_domo_type_match?'>ruby_domo_type_match?</span><span class='lparen'>(</span><span class='id identifier rubyid_val'>val</span><span class='comma'>,</span> <span class='id identifier rubyid_domo_column_type'>domo_column_type</span><span class='rparen'>)</span>
  <span class='kw'>case</span> <span class='id identifier rubyid_domo_column_type'>domo_column_type</span>
  <span class='kw'>when</span> <span class='const'>Java</span><span class='op'>::</span><span class='const'>ComDomoSdkDatasetsModel</span><span class='op'>::</span><span class='const'>ColumnType</span><span class='op'>::</span><span class='const'>DATE</span>
    <span class='kw'>return</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_val'>val</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Date</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid__'>_</span> <span class='op'>=</span> <span class='const'>Date</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='id identifier rubyid_val'>val</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='kw'>true</span>
    <span class='kw'>rescue</span> <span class='const'>ArgumentError</span>
      <span class='kw'>return</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
  <span class='kw'>when</span> <span class='const'>Java</span><span class='op'>::</span><span class='const'>ComDomoSdkDatasetsModel</span><span class='op'>::</span><span class='const'>ColumnType</span><span class='op'>::</span><span class='const'>DATETIME</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_val'>val</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>LogStash</span><span class='op'>::</span><span class='const'>Timestamp</span> <span class='kw'>or</span> <span class='id identifier rubyid_val'>val</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>DateTime</span> <span class='kw'>or</span> <span class='id identifier rubyid_val'>val</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Date</span> <span class='kw'>or</span> <span class='id identifier rubyid_val'>val</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Time</span>
      <span class='kw'>return</span> <span class='kw'>true</span>
    <span class='kw'>end</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid__'>_</span> <span class='op'>=</span> <span class='const'>DateTime</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='id identifier rubyid_val'>val</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='kw'>true</span>
    <span class='kw'>rescue</span> <span class='const'>ArgumentError</span>
      <span class='kw'>return</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
  <span class='kw'>when</span> <span class='const'>Java</span><span class='op'>::</span><span class='const'>ComDomoSdkDatasetsModel</span><span class='op'>::</span><span class='const'>ColumnType</span><span class='op'>::</span><span class='const'>LONG</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_val'>val</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Integer</span>
      <span class='kw'>return</span> <span class='kw'>true</span>
    <span class='kw'>end</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid__'>_</span> <span class='op'>=</span> <span class='const'>Integer</span><span class='lparen'>(</span><span class='id identifier rubyid_val'>val</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='kw'>true</span>
    <span class='kw'>rescue</span> <span class='const'>ArgumentError</span>
      <span class='kw'>return</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
  <span class='kw'>when</span> <span class='const'>Java</span><span class='op'>::</span><span class='const'>ComDomoSdkDatasetsModel</span><span class='op'>::</span><span class='const'>ColumnType</span><span class='op'>::</span><span class='const'>DOUBLE</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_val'>val</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Float</span>
      <span class='kw'>return</span> <span class='kw'>true</span>
    <span class='kw'>end</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid__'>_</span> <span class='op'>=</span> <span class='const'>Float</span><span class='lparen'>(</span><span class='id identifier rubyid_val'>val</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='kw'>true</span>
    <span class='kw'>rescue</span> <span class='const'>ArgumentError</span>
      <span class='kw'>return</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='kw'>true</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="send_to_domo-instance_method">
  
    #<strong>send_to_domo</strong>(force_pending = false, force_run = false)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Send Event data using the DOMO Streams API.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>force_pending</span>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>false</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Force process all pending jobs.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>force_run</span>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>false</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Ignore the commit status of the queue.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
579
580
581
582
583
584
585
586
587
588
589
590
591
592
593
594
595
596
597
598
599
600
601
602
603
604
605
606
607
608
609
610
611
612
613
614
615
616
617
618
619
620
621
622
623
624
625
626
627
628
629
630
631
632
633
634
635
636
637
638
639
640
641
642
643
644
645
646
647
648
649
650
651
652
653
654
655
656
657
658
659
660
661
662
663
664
665
666
667
668
669
670
671
672
673
674
675
676
677
678
679
680
681
682
683
684
685
686
687
688
689
690
691
692
693
694
695
696
697
698
699
700
701
702
703
704
705
706
707
708
709
710
711
712
713
714
715
716
717
718
719
720
721
722
723
724
725
726
727
728
729</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/logstash/outputs/domo.rb', line 521</span>

<span class='kw'>def</span> <span class='id identifier rubyid_send_to_domo'>send_to_domo</span><span class='lparen'>(</span><span class='id identifier rubyid_force_pending'>force_pending</span><span class='op'>=</span><span class='kw'>false</span><span class='comma'>,</span> <span class='id identifier rubyid_force_run'>force_run</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
  <span class='ivar'>@queue</span> <span class='op'>=</span> <span class='id identifier rubyid_get_queue'>get_queue</span>
  <span class='kw'>return</span> <span class='kw'>if</span> <span class='lparen'>(</span><span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_processed?'>processed?</span><span class='lparen'>(</span><span class='id identifier rubyid_force_pending'>force_pending</span><span class='rparen'>)</span> <span class='kw'>and</span> <span class='op'>!</span><span class='id identifier rubyid_force_run'>force_run</span><span class='rparen'>)</span> <span class='kw'>or</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_processing_status'>processing_status</span> <span class='op'>==</span> <span class='symbol'>:blocked_for_commit</span>

  <span class='comment'># Block until failed jobs are done reprocessing back into the queue
</span>  <span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='float'>0.1</span><span class='rparen'>)</span> <span class='kw'>until</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_failures'>failures</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&lt;=</span> <span class='int'>0</span> <span class='kw'>or</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_failures'>failures</span><span class='period'>.</span><span class='id identifier rubyid_processing_status'>processing_status</span> <span class='op'>!=</span> <span class='symbol'>:reprocessing</span>
  <span class='comment'># Process the queue
</span>  <span class='id identifier rubyid_loop'>loop</span> <span class='kw'>do</span>
    <span class='comment'># Update on each pass in case another thread managed to change things in a thread unsafe way
</span>    <span class='ivar'>@queue</span> <span class='op'>=</span> <span class='id identifier rubyid_get_queue'>get_queue</span>
    <span class='comment'># Merge pending jobs into one job and add it to the main queue if we&#39;re force processing pending jobs.
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_force_pending'>force_pending</span> <span class='kw'>and</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_pending_jobs'>pending_jobs</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>0</span>
      <span class='id identifier rubyid_data'>data</span> <span class='op'>=</span> <span class='id identifier rubyid_merge_pending_jobs!'>merge_pending_jobs!</span><span class='lparen'>(</span><span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='comma'>,</span> <span class='id identifier rubyid_force_pending'>force_pending</span><span class='rparen'>)</span>
      <span class='comment'># Prevent infinite loops
</span>      <span class='id identifier rubyid_force_pending'>force_pending</span> <span class='op'>=</span> <span class='kw'>false</span>
      <span class='ivar'>@queue</span> <span class='op'>&lt;&lt;</span> <span class='const'><span class='object_link'><a href="" title="LogStash::Outputs::Domo (class)">Domo</a></span></span><span class='op'>::</span><span class='const'>Queue</span><span class='op'>::</span><span class='const'>Job</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='comma'>,</span> <span class='int'>0</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&lt;=</span> <span class='int'>0</span>
      <span class='comment'># Restart the loop
</span>      <span class='kw'>next</span>
    <span class='kw'>end</span>

    <span class='comment'># Block the loop while commits are in progress
</span>    <span class='comment'># But also timeout after an hour to keep things moving during a likely failure
</span>    <span class='kw'>until</span> <span class='id identifier rubyid_force_run'>force_run</span> <span class='kw'>or</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_status'>commit_status</span> <span class='op'>!=</span> <span class='symbol'>:running</span> <span class='kw'>or</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_stuck?'>stuck?</span><span class='lparen'>(</span><span class='int'>3600</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='float'>0.1</span><span class='rparen'>)</span>
      <span class='kw'>next</span> <span class='kw'>unless</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span>
    <span class='kw'>end</span>

    <span class='kw'>break</span> <span class='kw'>if</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_processed?'>processed?</span><span class='lparen'>(</span><span class='id identifier rubyid_force_pending'>force_pending</span><span class='rparen'>)</span> <span class='kw'>or</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_force_commit?'>force_commit?</span><span class='lparen'>(</span><span class='ivar'>@commit_max_rows</span><span class='rparen'>)</span>

    <span class='comment'># Get the job from the queue
</span>    <span class='id identifier rubyid_job'>job</span> <span class='op'>=</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_pop'>pop</span>
    <span class='comment'># Skip the job if it has no data for some reason
</span>    <span class='kw'>unless</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='kw'>or</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_row_count'>row_count</span> <span class='op'>&gt;</span> <span class='int'>0</span>
      <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_processing_status'>processing_status</span> <span class='op'>=</span> <span class='symbol'>:open</span>
      <span class='kw'>next</span>
    <span class='kw'>end</span>
    <span class='comment'># If we&#39;re out of jobs, process any failures
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
      <span class='kw'>break</span> <span class='kw'>if</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_failures'>failures</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&lt;=</span> <span class='int'>0</span>

      <span class='comment'># Retry failures if we&#39;re into that sort of thing.
</span>      <span class='kw'>if</span> <span class='ivar'>@retry_failures</span> <span class='kw'>or</span> <span class='ivar'>@distributed_lock</span>
        <span class='comment'># Clear out or update the Job&#39;s Execution ID if its associated Stream Execution is no longer valid.
</span>        <span class='ivar'>@commit_lock_manager</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span><span class='lparen'>(</span><span class='id identifier rubyid_lock_key'>lock_key</span><span class='comma'>,</span> <span class='ivar'>@lock_timeout</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_locked'>locked</span><span class='op'>|</span>
          <span class='kw'>break</span> <span class='kw'>unless</span> <span class='id identifier rubyid_locked'>locked</span>

          <span class='comment'># Validate the queue&#39;s StreamExecution
</span>          <span class='kw'>unless</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
            <span class='kw'>begin</span>
              <span class='id identifier rubyid_stream_execution'>stream_execution</span> <span class='op'>=</span> <span class='ivar'>@domo_client</span><span class='period'>.</span><span class='id identifier rubyid_stream_client'>stream_client</span><span class='period'>.</span><span class='id identifier rubyid_getExecution'>getExecution</span><span class='lparen'>(</span><span class='ivar'>@stream_id</span><span class='comma'>,</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span><span class='rparen'>)</span>
              <span class='kw'>if</span> <span class='kw'>not</span> <span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='kw'>and</span> <span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='period'>.</span><span class='id identifier rubyid_currentState'>currentState</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ACTIVE</span><span class='tstring_end'>&quot;</span></span>
                <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span> <span class='op'>=</span> <span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='period'>.</span><span class='id identifier rubyid_getId'>getId</span>
              <span class='kw'>else</span>
                <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span> <span class='op'>=</span> <span class='kw'>nil</span>
              <span class='kw'>end</span>
            <span class='kw'>rescue</span> <span class='const'>Java</span><span class='op'>::</span><span class='const'>ComDomoSdkRequest</span><span class='op'>::</span><span class='const'>RequestException</span> <span class='op'>=&gt;</span><span class='id identifier rubyid_ex'>ex</span>
              <span class='comment'># HTTP status code from the API request
</span>              <span class='id identifier rubyid_status_code'>status_code</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="LogStash::Outputs::Domo (class)">Domo</a></span></span><span class='op'>::</span><span class='const'>Client</span><span class='period'>.</span><span class='id identifier rubyid_request_error_status_code'>request_error_status_code</span><span class='lparen'>(</span><span class='id identifier rubyid_ex'>ex</span><span class='rparen'>)</span>
              <span class='comment'># Clear the Queue&#39;s Execution ID if we got a 404
</span>              <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span> <span class='op'>=</span> <span class='kw'>nil</span> <span class='kw'>if</span> <span class='id identifier rubyid_status_code'>status_code</span> <span class='op'>==</span> <span class='int'>404</span>
              <span class='comment'># Other status code 4xx errors should be raised
</span>              <span class='id identifier rubyid_raise'>raise</span><span class='lparen'>(</span><span class='id identifier rubyid_ex'>ex</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_status_code'>status_code</span> <span class='op'>!=</span> <span class='int'>404</span> <span class='kw'>and</span> <span class='id identifier rubyid_status_code'>status_code</span> <span class='op'>&gt;=</span> <span class='int'>400</span> <span class='kw'>and</span> <span class='id identifier rubyid_status_code'>status_code</span> <span class='op'>&lt;</span> <span class='int'>500</span>
              <span class='comment'># Retry for 5xx or unknown errors
</span>              <span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='ivar'>@retry_delay</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_status_code'>status_code</span> <span class='op'>&lt;</span> <span class='int'>100</span> <span class='kw'>or</span> <span class='id identifier rubyid_status_code'>status_code</span> <span class='op'>&gt;=</span> <span class='int'>500</span>
              <span class='comment'># Regardless, restart the loop
</span>              <span class='kw'>next</span>
            <span class='kw'>end</span>
          <span class='kw'>end</span>
          <span class='comment'># Block if a commit started during the validation
</span>          <span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='float'>0.1</span><span class='rparen'>)</span> <span class='kw'>until</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_status'>commit_status</span> <span class='op'>!=</span> <span class='symbol'>:running</span> <span class='kw'>or</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_stuck?'>stuck?</span><span class='lparen'>(</span><span class='int'>3600</span><span class='rparen'>)</span>
          <span class='comment'># Reprocess the failed jobs
</span>          <span class='ivar'>@queue</span> <span class='op'>=</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_failures'>failures</span><span class='period'>.</span><span class='id identifier rubyid_reprocess_jobs!'>reprocess_jobs!</span>
          <span class='comment'># Block if another thread is reprocessing the jobs
</span>          <span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='float'>0.1</span><span class='rparen'>)</span> <span class='kw'>until</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_failures'>failures</span><span class='period'>.</span><span class='id identifier rubyid_processing_status'>processing_status</span> <span class='op'>!=</span> <span class='symbol'>:reprocessing</span>
        <span class='kw'>end</span>

        <span class='kw'>break</span> <span class='kw'>if</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_processed?'>processed?</span>
      <span class='comment'># Not retrying failures? I don&#39;t know why you aren&#39;t, but ok.
</span>      <span class='kw'>else</span>
        <span class='id identifier rubyid_commit_stream'>commit_stream</span>
        <span class='kw'>return</span>
      <span class='kw'>end</span>
      <span class='comment'># Restart the loop to process the failures.
</span>      <span class='kw'>next</span>
    <span class='kw'>end</span>
    <span class='comment'># Process the queued job and upload its data to Domo.
</span>    <span class='kw'>if</span> <span class='int'>0</span> <span class='op'>&lt;</span> <span class='ivar'>@commit_max_rows</span> <span class='kw'>and</span> <span class='ivar'>@commit_max_rows</span> <span class='op'>&lt;=</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_row_count'>row_count</span>
      <span class='id identifier rubyid_old_job'>old_job</span> <span class='op'>=</span> <span class='id identifier rubyid_job'>job</span>
      <span class='id identifier rubyid_job'>job</span> <span class='op'>=</span> <span class='id identifier rubyid_old_job'>old_job</span><span class='period'>.</span><span class='id identifier rubyid_slice!'>slice!</span><span class='lparen'>(</span><span class='int'>0</span><span class='comma'>,</span> <span class='ivar'>@commit_max_rows</span><span class='rparen'>)</span>
      <span class='ivar'>@queue</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_old_job'>old_job</span>
    <span class='kw'>end</span>
    <span class='kw'>begin</span>
      <span class='comment'># Block during commits
</span>      <span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='float'>0.1</span><span class='rparen'>)</span> <span class='kw'>until</span> <span class='id identifier rubyid_force_run'>force_run</span> <span class='kw'>or</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_status'>commit_status</span> <span class='op'>!=</span> <span class='symbol'>:running</span> <span class='kw'>or</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_stuck?'>stuck?</span><span class='lparen'>(</span><span class='int'>3600</span><span class='rparen'>)</span>
      <span class='comment'># Prevent unnecessary executions
</span>      <span class='kw'>return</span> <span class='kw'>if</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_processed?'>processed?</span> <span class='kw'>and</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_complete?'>commit_complete?</span>
      <span class='comment'># Get or create a Stream Execution
</span>      <span class='ivar'>@commit_lock_manager</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span><span class='lparen'>(</span><span class='id identifier rubyid_lock_key'>lock_key</span><span class='comma'>,</span> <span class='ivar'>@lock_timeout</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_locked'>locked</span><span class='op'>|</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_locked'>locked</span>
          <span class='id identifier rubyid_stream_execution'>stream_execution</span> <span class='op'>=</span> <span class='kw'>nil</span>
          <span class='comment'># Check if the Queue&#39;s existing Stream Execution is still valid.
</span>          <span class='kw'>unless</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
            <span class='id identifier rubyid_stream_execution'>stream_execution</span> <span class='op'>=</span> <span class='ivar'>@domo_client</span><span class='period'>.</span><span class='id identifier rubyid_stream_client'>stream_client</span><span class='period'>.</span><span class='id identifier rubyid_getExecution'>getExecution</span><span class='lparen'>(</span><span class='ivar'>@stream_id</span><span class='comma'>,</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span><span class='rparen'>)</span>
            <span class='kw'>if</span> <span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='period'>.</span><span class='id identifier rubyid_currentState'>currentState</span> <span class='op'>!=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ACTIVE</span><span class='tstring_end'>&quot;</span></span>
              <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Stream Exuection ID </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='period'>.</span><span class='id identifier rubyid_getId'>getId</span><span class='embexpr_end'>}</span><span class='tstring_content'> for Stream ID </span><span class='embexpr_beg'>#{</span><span class='ivar'>@stream_id</span><span class='embexpr_end'>}</span><span class='tstring_content'> is no longer active. Its current status is </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='period'>.</span><span class='id identifier rubyid_currentState'>currentState</span><span class='embexpr_end'>}</span><span class='tstring_content'>. A new Stream Execution will be created.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                            <span class='symbol'>:stream_id</span>         <span class='op'>=&gt;</span> <span class='ivar'>@stream_id</span><span class='comma'>,</span>
                            <span class='symbol'>:execution_id</span>      <span class='op'>=&gt;</span> <span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='period'>.</span><span class='id identifier rubyid_getId'>getId</span><span class='comma'>,</span>
                            <span class='symbol'>:pipeline_id</span>       <span class='op'>=&gt;</span> <span class='id identifier rubyid_pipeline_id'>pipeline_id</span><span class='comma'>,</span>
                            <span class='symbol'>:job</span>               <span class='op'>=&gt;</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_to_hash'>to_hash</span><span class='lparen'>(</span><span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
                            <span class='symbol'>:data</span>              <span class='op'>=&gt;</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
              <span class='id identifier rubyid_stream_execution'>stream_execution</span> <span class='op'>=</span> <span class='kw'>nil</span>
            <span class='kw'>end</span>
          <span class='kw'>end</span>
          <span class='comment'># We didn&#39;t find a valid execution so let&#39;s make a new one.
</span>          <span class='kw'>if</span> <span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
            <span class='comment'># If we&#39;re forcing processing and there&#39;s no Execution ID, we need to just return and let #commit_stream figure this mess out
</span>            <span class='kw'>if</span> <span class='id identifier rubyid_force_run'>force_run</span>
              <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_failures'>failures</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_job'>job</span>
              <span class='kw'>return</span>
            <span class='kw'>end</span>
            <span class='kw'>until</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_status'>commit_status</span> <span class='op'>!=</span> <span class='symbol'>:wait</span> <span class='kw'>and</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_status'>commit_status</span> <span class='op'>!=</span> <span class='symbol'>:running</span>
              <span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='float'>0.5</span><span class='rparen'>)</span>
              <span class='kw'>if</span> <span class='id identifier rubyid_locked'>locked</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Hash</span> <span class='kw'>and</span> <span class='id identifier rubyid_locked'>locked</span><span class='lbracket'>[</span><span class='symbol'>:validity</span><span class='rbracket'>]</span> <span class='op'>&lt;</span> <span class='int'>1000</span>
                <span class='id identifier rubyid_locked'>locked</span> <span class='op'>=</span> <span class='ivar'>@commit_lock_manager</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span><span class='lparen'>(</span><span class='id identifier rubyid_lock_key'>lock_key</span><span class='comma'>,</span> <span class='ivar'>@lock_timeout</span><span class='comma'>,</span> <span class='label'>extend:</span> <span class='id identifier rubyid_locked'>locked</span><span class='comma'>,</span> <span class='label'>extend_only_if_locked:</span> <span class='kw'>true</span><span class='rparen'>)</span>
              <span class='kw'>end</span>
            <span class='kw'>end</span>
            <span class='id identifier rubyid_stream_execution'>stream_execution</span> <span class='op'>=</span> <span class='ivar'>@domo_client</span><span class='period'>.</span><span class='id identifier rubyid_stream_client'>stream_client</span><span class='period'>.</span><span class='id identifier rubyid_createExecution'>createExecution</span><span class='lparen'>(</span><span class='ivar'>@stream_id</span><span class='rparen'>)</span>
            <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span> <span class='op'>=</span> <span class='id identifier rubyid_stream_execution'>stream_execution</span><span class='period'>.</span><span class='id identifier rubyid_getId'>getId</span>
            <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_status'>commit_status</span> <span class='op'>=</span> <span class='symbol'>:open</span>
          <span class='kw'>end</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
      <span class='comment'># If the queue is missing an Execution ID (e.g. another worker committed the execution before we got here),
</span>      <span class='comment'># then it&#39;s time to defer this job to the next round of processing.
</span>      <span class='kw'>if</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='kw'>or</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_status'>commit_status</span> <span class='op'>==</span> <span class='symbol'>:running</span>
        <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_data_part'>data_part</span> <span class='op'>=</span> <span class='kw'>nil</span>
        <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_unshift'>unshift</span><span class='lparen'>(</span><span class='id identifier rubyid_job'>job</span><span class='rparen'>)</span>
        <span class='kw'>next</span>
      <span class='kw'>end</span>
      <span class='comment'># Block until failed jobs are done reprocessing back into the queue
</span>      <span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='float'>0.1</span><span class='rparen'>)</span> <span class='kw'>until</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_upload_ready?'>upload_ready?</span>
      <span class='comment'># Prevent a race condition when a long running commit is underway
</span>      <span class='kw'>unless</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_status'>commit_status</span> <span class='op'>==</span> <span class='symbol'>:open</span>
        <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_data_part'>data_part</span> <span class='op'>=</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_data_part'>data_part</span><span class='op'>&amp;.</span><span class='id identifier rubyid_execution_id'>execution_id</span> <span class='op'>==</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span> <span class='op'>?</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_data_part'>data_part</span> <span class='op'>:</span> <span class='kw'>nil</span>
        <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_unshift'>unshift</span><span class='lparen'>(</span><span class='id identifier rubyid_job'>job</span><span class='rparen'>)</span>
        <span class='kw'>next</span>
      <span class='kw'>end</span>
      <span class='comment'># Reset and/or increment the job&#39;s data part if need be
</span>      <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_data_part'>data_part</span> <span class='op'>=</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_incr_data_part'>incr_data_part</span> <span class='kw'>if</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_data_part'>data_part</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='kw'>or</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_data_part'>data_part</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span> <span class='op'>!=</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span>
      <span class='comment'># Upload the job&#39;s data to Domo.
</span>      <span class='ivar'>@domo_client</span><span class='period'>.</span><span class='id identifier rubyid_stream_client'>stream_client</span><span class='period'>.</span><span class='id identifier rubyid_uploadDataPart'>uploadDataPart</span><span class='lparen'>(</span><span class='ivar'>@stream_id</span><span class='comma'>,</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_data_part'>data_part</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span><span class='comma'>,</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_data_part'>data_part</span><span class='period'>.</span><span class='id identifier rubyid_part_id'>part_id</span><span class='comma'>,</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_upload_data'>upload_data</span><span class='rparen'>)</span>
      <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_add_commit_rows'>add_commit_rows</span><span class='lparen'>(</span><span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_row_count'>row_count</span><span class='rparen'>)</span>
      <span class='comment'># Debug log output
</span>      <span class='id identifier rubyid_execution_id'>execution_id</span> <span class='op'>=</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>?</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span> <span class='op'>:</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span>
      <span class='id identifier rubyid_queue_pipeline_id'>queue_pipeline_id</span> <span class='op'>=</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>?</span> <span class='id identifier rubyid_pipeline_id'>pipeline_id</span> <span class='op'>:</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_pipeline_id'>pipeline_id</span>
      <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Successfully wrote data to DOMO.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                    <span class='symbol'>:stream_id</span>         <span class='op'>=&gt;</span> <span class='ivar'>@stream_id</span><span class='comma'>,</span>
                    <span class='symbol'>:execution_id</span>      <span class='op'>=&gt;</span> <span class='id identifier rubyid_execution_id'>execution_id</span><span class='comma'>,</span>
                    <span class='symbol'>:queue_pipeline_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_queue_pipeline_id'>queue_pipeline_id</span><span class='comma'>,</span>
                    <span class='symbol'>:commit_rows</span>       <span class='op'>=&gt;</span> <span class='ivar'>@queue</span><span class='op'>&amp;.</span><span class='id identifier rubyid_commit_rows'>commit_rows</span><span class='comma'>,</span>
                    <span class='symbol'>:job</span>               <span class='op'>=&gt;</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_to_hash'>to_hash</span><span class='lparen'>(</span><span class='kw'>true</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='kw'>rescue</span> <span class='const'>Java</span><span class='op'>::</span><span class='const'>ComDomoSdkRequest</span><span class='op'>::</span><span class='const'>RequestException</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='id identifier rubyid_status_code'>status_code</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="LogStash::Outputs::Domo (class)">Domo</a></span></span><span class='op'>::</span><span class='const'>Client</span><span class='period'>.</span><span class='id identifier rubyid_request_error_status_code'>request_error_status_code</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='rparen'>)</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_status_code'>status_code</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='kw'>or</span> <span class='id identifier rubyid_status_code'>status_code</span> <span class='op'>==</span> <span class='op'>-</span><span class='int'>1</span>
        <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>We got a status code of -1 somehow. Let&#39;s look at the exception.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                      <span class='symbol'>:exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span><span class='comma'>,</span>
                      <span class='symbol'>:status_code</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_status_code'>status_code</span><span class='comma'>,</span>
                      <span class='symbol'>:message</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
      <span class='comment'># DOMO sends back a 400 if a data part is uploaded to an Execution that&#39;s done committing. Hence the &lt;= 400
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_status_code'>status_code</span> <span class='op'>&lt;=</span> <span class='int'>400</span> <span class='kw'>or</span> <span class='id identifier rubyid_status_code'>status_code</span> <span class='op'>&gt;=</span> <span class='int'>500</span> <span class='kw'>or</span> <span class='id identifier rubyid_status_code'>status_code</span> <span class='op'>==</span> <span class='int'>404</span>
        <span class='comment'># Queue the job to be retried if we&#39;re using the distributed lock or configured to retry.
</span>        <span class='kw'>if</span> <span class='ivar'>@retry_failures</span> <span class='kw'>or</span> <span class='ivar'>@distributed_lock</span>
          <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Got a retriable error from the DOMO Streams API.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                       <span class='symbol'>:code</span>              <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_getStatusCode'>getStatusCode</span><span class='comma'>,</span>
                       <span class='symbol'>:exception</span>         <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span><span class='comma'>,</span>
                       <span class='symbol'>:stream_id</span>         <span class='op'>=&gt;</span> <span class='ivar'>@stream_id</span><span class='comma'>,</span>
                       <span class='symbol'>:execution_id</span>      <span class='op'>=&gt;</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span><span class='comma'>,</span>
                       <span class='symbol'>:job</span>               <span class='op'>=&gt;</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_to_hash'>to_hash</span><span class='lparen'>(</span><span class='kw'>true</span><span class='rparen'>)</span><span class='rparen'>)</span>
          <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_failures'>failures</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_job'>job</span>
          <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_warn'>warn</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Will sleep for </span><span class='embexpr_beg'>#{</span><span class='ivar'>@retry_delay</span><span class='embexpr_end'>}</span><span class='tstring_content'> seconds before retrying requests.</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
          <span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='ivar'>@retry_delay</span><span class='rparen'>)</span>
        <span class='kw'>else</span>
          <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Encountered a fatal error interacting with the DOMO Streams API.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                        <span class='symbol'>:code</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_getStatusCode'>getStatusCode</span><span class='comma'>,</span>
                        <span class='symbol'>:exception</span>  <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span><span class='comma'>,</span>
                        <span class='symbol'>:job</span>        <span class='op'>=&gt;</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_to_hash'>to_hash</span><span class='lparen'>(</span><span class='kw'>true</span><span class='rparen'>)</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
      <span class='comment'># Something really ain&#39;t right.
</span>      <span class='comment'># We used to write to the DLQ in this scenario, but,
</span>      <span class='comment'># since we&#39;re batch processing now, we&#39;ll have to just add it to the failures queue and pray.
</span>      <span class='kw'>else</span>
        <span class='id identifier rubyid_log_message'>log_message</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Encountered a fatal error interacting with the DOMO Streams API.</span><span class='tstring_end'>&quot;</span></span>
        <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span><span class='lparen'>(</span><span class='id identifier rubyid_log_message'>log_message</span><span class='comma'>,</span>
                      <span class='symbol'>:code</span>       <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_getStatusCode'>getStatusCode</span><span class='comma'>,</span>
                      <span class='symbol'>:exception</span>  <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span><span class='comma'>,</span>
                      <span class='symbol'>:job</span>        <span class='op'>=&gt;</span> <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_to_hash'>to_hash</span><span class='lparen'>(</span><span class='kw'>true</span><span class='rparen'>)</span><span class='rparen'>)</span>
        <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_failures'>failures</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_job'>job</span> <span class='kw'>unless</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
      <span class='kw'>end</span>
    <span class='kw'>ensure</span>
      <span class='ivar'>@queue</span> <span class='op'>=</span> <span class='id identifier rubyid_get_queue'>get_queue</span> <span class='kw'>if</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
      <span class='kw'>if</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_force_commit?'>force_commit?</span><span class='lparen'>(</span><span class='ivar'>@commit_max_rows</span><span class='rparen'>)</span>
        <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_processing_status'>processing_status</span> <span class='op'>=</span> <span class='symbol'>:blocked_for_commit</span>
        <span class='kw'>break</span>
      <span class='kw'>end</span>
      <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_processing_status'>processing_status</span> <span class='op'>=</span> <span class='symbol'>:open</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="symbolize_redis_client_args-instance_method">
  
    #<strong>symbolize_redis_client_args</strong>(redis_client_args)  &#x21d2; <tt>Hash</tt>  <span class="extras">(private)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Convert all keys in the redis_client hash to symbols because Logstash makes
them keys, but redis-rb wants symbols.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>redis_client_args</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1178
1179
1180
1181
1182
1183
1184
1185
1186
1187
1188</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/logstash/outputs/domo.rb', line 1178</span>

<span class='kw'>def</span> <span class='id identifier rubyid_symbolize_redis_client_args'>symbolize_redis_client_args</span><span class='lparen'>(</span><span class='id identifier rubyid_redis_client_args'>redis_client_args</span><span class='rparen'>)</span>
  <span class='comment'># redis_client_args = redis_client_args.inject({}) {|memo, (k, v)| memo[k.to_sym] = v; memo}
</span>  <span class='id identifier rubyid_redis_client_args'>redis_client_args</span> <span class='op'>=</span> <span class='id identifier rubyid_recursive_symbolize'>recursive_symbolize</span><span class='lparen'>(</span><span class='id identifier rubyid_redis_client_args'>redis_client_args</span><span class='rparen'>)</span>
  <span class='kw'>unless</span> <span class='id identifier rubyid_redis_client_args'>redis_client_args</span><span class='period'>.</span><span class='id identifier rubyid_fetch'>fetch</span><span class='lparen'>(</span><span class='symbol'>:sentinels</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='id identifier rubyid_redis_client_args'>redis_client_args</span><span class='lbracket'>[</span><span class='symbol'>:sentinels</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_redis_client_args'>redis_client_args</span><span class='lbracket'>[</span><span class='symbol'>:sentinels</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_sentinel'>sentinel</span><span class='op'>|</span>
      <span class='id identifier rubyid_sentinel'>sentinel</span><span class='period'>.</span><span class='id identifier rubyid_inject'>inject</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_memo'>memo</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='rparen'>)</span><span class='op'>|</span> <span class='id identifier rubyid_memo'>memo</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_v'>v</span><span class='semicolon'>;</span> <span class='id identifier rubyid_memo'>memo</span><span class='rbrace'>}</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_redis_client_args'>redis_client_args</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="try_commit-instance_method">
  
    #<strong>try_commit</strong>(shutdown = false)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/logstash/outputs/domo.rb', line 427</span>

<span class='kw'>def</span> <span class='id identifier rubyid_try_commit'>try_commit</span><span class='lparen'>(</span><span class='id identifier rubyid_shutdown'>shutdown</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_commit_ready?'>commit_ready?</span> <span class='kw'>and</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span>
    <span class='id identifier rubyid_commit_stream'>commit_stream</span><span class='lparen'>(</span><span class='id identifier rubyid_shutdown'>shutdown</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_scheduled?'>commit_scheduled?</span>

    <span class='kw'>if</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_stalled?'>commit_stalled?</span><span class='lparen'>(</span><span class='ivar'>@commit_delay</span><span class='rparen'>)</span> <span class='kw'>and</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_scheduled?'>commit_scheduled?</span>
      <span class='ivar'>@semaphore</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span><span class='lparen'>(</span><span class='id identifier rubyid_lock_key'>lock_key</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_locked'>locked</span><span class='op'>|</span>
        <span class='ivar'>@commit_task</span><span class='period'>.</span><span class='id identifier rubyid_cancel'>cancel</span> <span class='kw'>if</span> <span class='id identifier rubyid_locked'>locked</span> <span class='kw'>and</span> <span class='ivar'>@commit_task</span><span class='op'>&amp;.</span><span class='id identifier rubyid_pending?'>pending?</span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_commit_stream'>commit_stream</span><span class='lparen'>(</span><span class='id identifier rubyid_shutdown'>shutdown</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_shutdown'>shutdown</span>
    <span class='ivar'>@semaphore</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span><span class='lparen'>(</span><span class='id identifier rubyid_lock_key'>lock_key</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_locked'>locked</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_locked'>locked</span>
        <span class='kw'>if</span> <span class='ivar'>@commit_task</span><span class='op'>&amp;.</span><span class='id identifier rubyid_processing?'>processing?</span>
          <span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='float'>0.1</span><span class='rparen'>)</span> <span class='kw'>while</span> <span class='ivar'>@commit_task</span><span class='op'>&amp;.</span><span class='id identifier rubyid_processing?'>processing?</span>
        <span class='kw'>else</span>
          <span class='ivar'>@commit_task</span><span class='period'>.</span><span class='id identifier rubyid_cancel'>cancel</span> <span class='kw'>unless</span> <span class='ivar'>@commit_task</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='kw'>or</span> <span class='ivar'>@commit_task</span><span class='period'>.</span><span class='id identifier rubyid_complete?'>complete?</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_commit_stream'>commit_stream</span><span class='lparen'>(</span><span class='id identifier rubyid_shutdown'>shutdown</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_processed?'>processed?</span><span class='lparen'>(</span><span class='kw'>true</span><span class='rparen'>)</span> <span class='kw'>and</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>else</span>
    <span class='comment'># The amount of time to sleep before committing.
</span>    <span class='id identifier rubyid_sleep_time'>sleep_time</span> <span class='op'>=</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_delay'>commit_delay</span><span class='lparen'>(</span><span class='ivar'>@commit_delay</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_sleep_time'>sleep_time</span> <span class='op'>&gt;</span> <span class='int'>0</span> <span class='kw'>and</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_status'>commit_status</span> <span class='op'>!=</span> <span class='symbol'>:running</span>
      <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_status'>commit_status</span> <span class='op'>=</span> <span class='symbol'>:open</span> <span class='kw'>unless</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_status'>commit_status</span> <span class='op'>==</span> <span class='symbol'>:blocked_for_commit</span>

      <span class='id identifier rubyid_thread_locked'>thread_locked</span> <span class='op'>=</span> <span class='ivar'>@semaphore</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span><span class='lparen'>(</span><span class='id identifier rubyid_lock_key'>lock_key</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_thread_locked'>thread_locked</span>

      <span class='kw'>if</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_stalled?'>commit_stalled?</span><span class='lparen'>(</span><span class='ivar'>@commit_delay</span><span class='rparen'>)</span>
        <span class='kw'>if</span> <span class='ivar'>@commit_task</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='kw'>and</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span>
          <span class='ivar'>@commit_task</span> <span class='op'>=</span> <span class='const'>Concurrent</span><span class='op'>::</span><span class='const'>ScheduledTask</span><span class='period'>.</span><span class='id identifier rubyid_execute'>execute</span><span class='lparen'>(</span><span class='float'>0.0</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_commit_stream'>commit_stream</span><span class='lparen'>(</span><span class='id identifier rubyid_shutdown'>shutdown</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
        <span class='kw'>elsif</span> <span class='ivar'>@commit_task</span><span class='op'>&amp;.</span><span class='id identifier rubyid_pending?'>pending?</span>
          <span class='ivar'>@commit_task</span><span class='period'>.</span><span class='id identifier rubyid_reschedule'>reschedule</span><span class='lparen'>(</span><span class='id identifier rubyid_sleep_time'>sleep_time</span><span class='rparen'>)</span>
          <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_schedule'>schedule</span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='float'>0.1</span><span class='rparen'>)</span> <span class='kw'>until</span> <span class='ivar'>@commit_task</span><span class='period'>.</span><span class='id identifier rubyid_complete?'>complete?</span> <span class='kw'>if</span> <span class='ivar'>@commit_task</span><span class='op'>&amp;.</span><span class='id identifier rubyid_processing?'>processing?</span>

        <span class='kw'>if</span> <span class='ivar'>@commit_task</span><span class='op'>&amp;.</span><span class='id identifier rubyid_incomplete?'>incomplete?</span> <span class='kw'>and</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span>
          <span class='kw'>if</span> <span class='id identifier rubyid_thread_locked'>thread_locked</span>
            <span class='ivar'>@commit_task</span><span class='period'>.</span><span class='id identifier rubyid_cancel'>cancel</span>
            <span class='ivar'>@commit_task</span> <span class='op'>=</span> <span class='const'>Concurrent</span><span class='op'>::</span><span class='const'>ScheduledTask</span><span class='period'>.</span><span class='id identifier rubyid_execute'>execute</span><span class='lparen'>(</span><span class='id identifier rubyid_sleep_time'>sleep_time</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_commit_stream'>commit_stream</span><span class='lparen'>(</span><span class='id identifier rubyid_shutdown'>shutdown</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
          <span class='kw'>end</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>

      <span class='kw'>if</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_unscheduled?'>commit_unscheduled?</span> <span class='kw'>and</span> <span class='ivar'>@commit_task</span><span class='op'>&amp;.</span><span class='id identifier rubyid_pending?'>pending?</span>
        <span class='id identifier rubyid_scheduled_time'>scheduled_time</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@commit_task</span><span class='period'>.</span><span class='id identifier rubyid_schedule_time'>schedule_time</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_utc'>utc</span>
        <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_schedule'>schedule</span><span class='lparen'>(</span><span class='id identifier rubyid_scheduled_time'>scheduled_time</span> <span class='op'>-</span> <span class='ivar'>@commit_delay</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
      <span class='kw'>if</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_unscheduled?'>commit_unscheduled?</span> <span class='kw'>and</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span>
        <span class='kw'>begin</span>
          <span class='ivar'>@commit_lock_manager</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span><span class='lparen'>(</span><span class='id identifier rubyid_commit_lock_key'>commit_lock_key</span><span class='comma'>,</span> <span class='ivar'>@lock_timeout</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_locked'>locked</span><span class='op'>|</span>
            <span class='kw'>if</span> <span class='id identifier rubyid_locked'>locked</span> <span class='kw'>and</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_unscheduled?'>commit_unscheduled?</span>
              <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_schedule'>schedule</span>
              <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The API is not ready for committing yet. Will sleep for %0.2f seconds.</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='lbracket'>[</span><span class='id identifier rubyid_sleep_time'>sleep_time</span><span class='rbracket'>]</span><span class='comma'>,</span>
                           <span class='symbol'>:stream_id</span>    <span class='op'>=&gt;</span> <span class='ivar'>@stream_id</span><span class='comma'>,</span>
                           <span class='symbol'>:pipeline_id</span>  <span class='op'>=&gt;</span> <span class='id identifier rubyid_pipeline_id'>pipeline_id</span><span class='comma'>,</span>
                           <span class='symbol'>:dataset_id</span>   <span class='op'>=&gt;</span> <span class='ivar'>@dataset_id</span><span class='comma'>,</span>
                           <span class='symbol'>:execution_id</span> <span class='op'>=&gt;</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_execution_id'>execution_id</span><span class='comma'>,</span>
                           <span class='symbol'>:commit_delay</span> <span class='op'>=&gt;</span> <span class='ivar'>@commit_delay</span><span class='comma'>,</span>
                           <span class='symbol'>:sleep_time</span>   <span class='op'>=&gt;</span> <span class='id identifier rubyid_sleep_time'>sleep_time</span><span class='comma'>,</span>
                           <span class='symbol'>:last_commit</span>  <span class='op'>=&gt;</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_last_commit'>last_commit</span><span class='comma'>,</span>
                           <span class='symbol'>:next_commit</span>  <span class='op'>=&gt;</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_next_commit'>next_commit</span><span class='lparen'>(</span><span class='ivar'>@commit_delay</span><span class='rparen'>)</span><span class='comma'>,</span>
                           <span class='symbol'>:commit_rows</span>  <span class='op'>=&gt;</span> <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_commit_rows'>commit_rows</span><span class='rparen'>)</span>
              <span class='ivar'>@semaphore</span><span class='period'>.</span><span class='id identifier rubyid_unlock'>unlock</span><span class='lparen'>(</span><span class='id identifier rubyid_thread_locked'>thread_locked</span><span class='rparen'>)</span>
              <span class='ivar'>@commit_task</span> <span class='op'>=</span> <span class='const'>Concurrent</span><span class='op'>::</span><span class='const'>ScheduledTask</span><span class='period'>.</span><span class='id identifier rubyid_execute'>execute</span><span class='lparen'>(</span><span class='id identifier rubyid_sleep_time'>sleep_time</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_commit_stream'>commit_stream</span><span class='lparen'>(</span><span class='id identifier rubyid_shutdown'>shutdown</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
            <span class='kw'>else</span>
              <span class='ivar'>@semaphore</span><span class='period'>.</span><span class='id identifier rubyid_unlock'>unlock</span><span class='lparen'>(</span><span class='id identifier rubyid_thread_locked'>thread_locked</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_thread_locked'>thread_locked</span>
            <span class='kw'>end</span>
          <span class='kw'>end</span>
        <span class='kw'>rescue</span> <span class='const'>Redis</span><span class='op'>::</span><span class='const'>BaseConnectionError</span>
          <span class='comment'># Once redlock-rb does a release with this pull request we can drop this rescue block https://github.com/leandromoreira/redlock-rb/pull/75
</span>          <span class='ivar'>@semaphore</span><span class='period'>.</span><span class='id identifier rubyid_unlock'>unlock</span><span class='lparen'>(</span><span class='id identifier rubyid_thread_locked'>thread_locked</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_thread_locked'>thread_locked</span>
        <span class='kw'>end</span>
      <span class='kw'>elsif</span> <span class='ivar'>@commit_task</span><span class='op'>&amp;.</span><span class='id identifier rubyid_pending?'>pending?</span>
        <span class='ivar'>@commit_task</span><span class='period'>.</span><span class='id identifier rubyid_reschedule'>reschedule</span><span class='lparen'>(</span><span class='id identifier rubyid_sleep_time'>sleep_time</span><span class='rparen'>)</span>
        <span class='ivar'>@queue</span><span class='period'>.</span><span class='id identifier rubyid_schedule'>schedule</span>
        <span class='ivar'>@semaphore</span><span class='period'>.</span><span class='id identifier rubyid_unlock'>unlock</span><span class='lparen'>(</span><span class='id identifier rubyid_thread_locked'>thread_locked</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_thread_locked'>thread_locked</span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_commit_stream'>commit_stream</span><span class='lparen'>(</span><span class='id identifier rubyid_shutdown'>shutdown</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Thu Sep 10 18:48:08 2020 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.25 (ruby-2.5.3).
</div>

    </div>
  </body>
</html>